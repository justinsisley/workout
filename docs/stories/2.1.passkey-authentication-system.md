# Story 2.1: Passkey Authentication System

## Status
Draft

## Story
**As a** product user,
**I want** to authenticate using a username and passkey,
**so that** I can securely access the workout app without complex password management.

## Acceptance Criteria

1. **Username input screen** accepts valid usernames with proper formatting and validation
2. **Username availability check** verifies username uniqueness before registration
3. **Passkey registration** allows users to create passkeys using WebAuthN
4. **Passkey authentication** enables secure login using registered passkeys
5. **User session management** maintains authenticated state across app usage
6. **Username storage** securely stores user usernames as unique identifiers
7. **Passkey credential storage** securely stores WebAuthN credentials
8. **Rate limiting** prevents abuse of the authentication system
9. **Error handling** provides clear feedback for invalid usernames or authentication failures
10. **Mobile optimization** includes touch-friendly interface optimized for mobile devices
11. **Security measures** implement proper session management and data protection
12. **Browser compatibility** ensures WebAuthN works across supported browsers

## Tasks / Subtasks

- [x] Create ProductUsers PayloadCMS collection (AC: 6, 7)
  - [x] Define product-users.ts collection with username and passkey credentials
  - [x] Implement progressive validation for flexible saving
  - [x] Add username uniqueness validation  
  - [x] Configure admin interface for product user management

- [x] Implement WebAuthN passkey registration (AC: 3, 12)
  - [x] Create registration server action using @simplewebauthn/server
  - [x] Implement navigator.credentials.create() in frontend
  - [x] Store passkey credentials in ProductUsers collection
  - [x] Handle browser compatibility and fallback guidance

- [x] Implement WebAuthN passkey authentication (AC: 4, 12)
  - [x] Create authentication server action using @simplewebauthn/server
  - [x] Implement navigator.credentials.get() in frontend
  - [x] Verify passkey credentials against stored data

- [x] Install required ShadCN/ui components (AC: 10)
  - [x] Install ShadCN/ui Button, Input, Form, Card, Label, Alert components
  - [x] Install ShadCN/ui Spinner/Loading component for loading states
  - [x] Verify components are properly configured in project

- [ ] Create username registration interface (AC: 1, 2, 9, 10)
  - [ ] Build username input form using ShadCN/ui Form, Input, Button components
  - [ ] Use ShadCN/ui Card for form container layout
  - [ ] Implement username availability checking with ShadCN/ui Alert for feedback
  - [ ] Add input validation using ShadCN/ui form validation patterns
  - [ ] Use ShadCN/ui responsive design for mobile touch interaction

- [ ] Create passkey authentication interface (AC: 4, 9, 10)
  - [ ] Build passkey login component using ShadCN/ui Form and Button components
  - [ ] Use ShadCN/ui Card for consistent layout with registration
  - [ ] Implement WebAuthN browser API calls with ShadCN/ui loading states
  - [ ] Add error handling using ShadCN/ui Alert components
  - [ ] Leverage ShadCN/ui mobile-optimized design patterns

- [ ] Implement user session management (AC: 5, 11)
  - [ ] Generate and return JWT token on successful authentication
  - [ ] Create auth store using Zustand for state management
  - [ ] Implement JWT token storage and validation
  - [ ] Create middleware for protected route authentication
  - [ ] Add session persistence across app usage

- [ ] Add rate limiting and security measures (AC: 8, 11)
  - [ ] Implement rate limiting for authentication endpoints
  - [ ] Add proper session management and data protection
  - [ ] Ensure secure credential storage practices
  - [ ] Add security headers and protections

- [ ] Create authentication workflow integration (AC: 5)
  - [ ] Integrate with existing app routing structure
  - [ ] Connect authentication state to workout app features
  - [ ] Implement logout functionality
  - [ ] Test complete authentication flow

## Dev Notes

### Previous Story Context
From Story 1.4: Complete Program Data Population - The PayloadCMS infrastructure and collections are fully established with embedded program structure. The ProductUsers collection needs to be added to support product user authentication separate from PayloadCMS admin users.

### PayloadCMS Collections Architecture
[Source: architecture/payloadcms-collections.md]

**Admin User vs Product User Separation:**
- PayloadCMS admin users (`users` collection) use email/password authentication for admin interface
- Product users (`productUsers` collection) use WebAuthN passkey authentication for workout app
- Complete separation ensures security isolation and clear system boundaries
- Product users have no access to PayloadCMS admin interface

**ProductUsers Collection Structure:**
```typescript
interface ProductUser {
  id: string
  username?: string // Optional for progressive validation
  passkeyCredentials?: WebAuthNCredential[] // Store passkey credentials
  currentProgram?: string // Reference to Programs collection
  currentMilestone?: number // Current milestone index
  currentDay?: number // Current day index
  createdAt: Date
  updatedAt: Date
}
```

**Progressive Validation Strategy:**
- Allow saving incomplete product users during registration flow
- No required fields at save time - supports iterative user creation
- Username and passkey can be saved separately during multi-step registration

### WebAuthN/FIDO2 Integration
[Source: architecture/external-apis.md]

**Required Technologies:**
- `@simplewebauthn/server` for server-side WebAuthN operations
- `navigator.credentials.create()` for passkey registration
- `navigator.credentials.get()` for passkey authentication
- Public key cryptography with passkeys (no external API rate limits)

**Implementation Requirements:**
- Proper challenge generation and verification
- Secure credential storage in PayloadCMS ProductUsers collection
- Browser compatibility checks with fallback guidance
- Mobile-optimized WebAuthN experience

### Authentication Architecture
[Source: architecture/core-workflows.md#product-user-authentication-workflow]

**Authentication Flow:**
1. User enters username → Check availability → Username stored
2. WebAuthN passkey registration → Browser biometric/PIN prompt
3. Passkey credential → Store in ProductUsers collection
4. JWT token generation → Authentication successful
5. Session state management → Access workout app

**Server Actions Integration:**
[Source: architecture/backend-architecture.md]
- Use server actions for all authentication operations
- Follow server action template with proper error handling
- Implement getCurrentProductUser() helper for session management
- Use PayloadCMS Local API for all database operations

### Frontend Architecture
[Source: architecture/frontend-architecture.md]

**Component Organization:**
- Authentication components: `src/components/auth/`
- Route structure: `src/app/(frontend)/login/` and `src/app/(frontend)/register/`
- State management: `src/stores/auth-store.ts` using Zustand

**Auth Store Structure:**
```typescript
interface AuthState {
  productUser: ProductUser | null
  isAuthenticated: boolean
  isLoading: boolean
  setProductUser: (productUser: ProductUser | null) => void
  setLoading: (loading: boolean) => void
  logout: () => void
}
```

**ShadCN/ui Component Strategy:**
- **MANDATORY:** Use existing ShadCN/ui components as building blocks - DO NOT build custom UI components from scratch
- Install required ShadCN/ui components: Button, Input, Form, Card, Label, Alert, Spinner/Loading
- Compose authentication interfaces using ShadCN/ui primitives only
- Touch-friendly interfaces optimized for mobile devices using ShadCN/ui responsive design
- Consistent mobile experience through ShadCN/ui component library

### File Locations
[Source: architecture/unified-project-structure.md]

**PayloadCMS Configuration:**
- Collection: `src/payload/collections/product-users.ts`
- PayloadCMS config: `src/payload/payload.config.ts`

**Server Actions:**
- Authentication actions: `src/actions/auth.ts`
- Follow server action template with proper error handling

**Frontend Components:**
- Auth components: `src/components/auth/`
- Login page: `src/app/(frontend)/login/page.tsx`
- Register page: `src/app/(frontend)/register/page.tsx`

**State Management:**
- Auth store: `src/stores/auth-store.ts`
- Types: `src/types/auth.ts`

**Middleware:**
- Route protection: `middleware.ts` (root level)
- Auth helpers: `src/lib/auth.ts`

### Technology Stack Requirements
[Source: architecture/tech-stack.md]

**Critical Dependencies:**
- WebAuthN/FIDO2: Latest version for passkey authentication
- @simplewebauthn/server: Server-side WebAuthN operations
- Zustand: Latest for state management
- Zod 4.1+: Schema validation and type safety for auth inputs
- Next.js 15.5+: Server actions and middleware support
- **ShadCN/ui: Latest** - UI component library for consistent, accessible components

### ShadCN/ui Component Implementation Strategy

**CRITICAL REQUIREMENT:** All UI components MUST be built using ShadCN/ui components as building blocks.

**Required ShadCN/ui Components to Install:**
- `Button` - For all interactive actions (login, register, submit)
- `Input` - For username input fields
- `Form` - For form structure and validation
- `Card` - For consistent layout containers
- `Label` - For accessible form labels
- `Alert` - For error messages and feedback
- `Spinner` or equivalent Loading component - For loading states

**Implementation Approach:**
- **DO NOT** create custom UI components from scratch
- **DO** compose authentication interfaces using ShadCN/ui primitives
- **DO** leverage ShadCN/ui's mobile-first responsive design
- **DO** use ShadCN/ui's built-in accessibility features
- **DO** follow ShadCN/ui patterns for form validation and error handling

**Component Architecture:**
- Authentication forms = ShadCN/ui Form + Input + Button + Alert
- Layout containers = ShadCN/ui Card components
- Loading states = ShadCN/ui Spinner/Loading components
- Error feedback = ShadCN/ui Alert components with appropriate variants

### Security and Performance
**Rate Limiting:** Implement proper rate limiting for auth endpoints
**Session Management:** JWT tokens with secure storage
**Data Protection:** Secure passkey credential storage
**Browser Support:** WebAuthN compatibility with fallback guidance

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Frontend auth tests: `tests/components/auth/`
- Backend auth tests: `tests/actions/auth.test.ts`
- PayloadCMS integration: `tests/payload/collections.test.ts`
- E2E authentication flow: `tests/e2e/auth-flow.spec.ts`

**Testing Framework:**
- Frontend: Vitest + Testing Library for auth components
- Backend: Vitest for server actions testing
- E2E: Playwright for complete authentication workflows

**Testing Philosophy:**
- DO NOT test PayloadCMS collection configurations (framework already tested)
- DO test custom WebAuthN integration logic
- DO test authentication server actions and business logic
- DO test auth component user interactions
- DO test end-to-end authentication workflow

**Story-Specific Test Cases:**
- Test username validation and availability checking using ShadCN/ui form components
- Test WebAuthN passkey registration and authentication flows with ShadCN/ui interactions
- Test auth store state management and integration with UI components
- Test ShadCN/ui mobile-optimized authentication interface responsiveness
- Test ShadCN/ui Alert component error handling and feedback
- Test rate limiting and security measures
- Test browser compatibility and error handling
- Test ShadCN/ui component accessibility features

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 1.0 | Initial story creation with comprehensive architecture context and WebAuthN implementation details | Bob (Scrum Master) |
| 2025-09-10 | 1.1 | **CRITICAL UPDATE:** Added mandatory ShadCN/ui component strategy with specific component requirements. Made it explicit that all UI must be built using ShadCN/ui primitives, not custom components from scratch. | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Task 1: Creating ProductUsers PayloadCMS collection - COMPLETED

### Completion Notes List
- Task 1 COMPLETED: ProductUsers collection already existed with proper structure. Verified username uniqueness validation, passkey credentials array, and admin interface configuration. Progressive validation is handled at the application level, not database level.
- Task 2.1 COMPLETED: Created registration server action using @simplewebauthn/server. Implemented checkUsernameAvailability(), generatePasskeyRegistrationOptions(), and verifyPasskeyRegistration() functions. Added webauthnChallenge field to ProductUsers collection for temporary challenge storage. Installed @simplewebauthn/server dependency and updated auth types.
- Task 2.2 COMPLETED: Implemented frontend WebAuthN passkey registration using navigator.credentials.create(). Created PasskeyRegistration component with ShadCN/ui components (Button, Input, Form, Card, Label, Alert). Integrated @simplewebauthn/browser for WebAuthN operations. Added proper form validation with react-hook-form and zod. Implemented mobile-optimized interface with loading states and error handling.
- Task 2.3 COMPLETED: Passkey credentials storage already implemented in verifyPasskeyRegistration server action. Credentials are stored in ProductUsers collection with proper structure including credentialID, publicKey, counter, deviceType, backedUp status, transports, and registrationDate. Implementation passes type checking and linting.
- Task 2.4 COMPLETED: Added comprehensive browser compatibility checks using @simplewebauthn/browser.browserSupportsWebAuthn() and additional validation for navigator.credentials API and secure context. Implemented fallback UI with detailed guidance for unsupported browsers/devices, specific WebAuthN error handling with user-friendly messages, and loading states during compatibility checks. Enhanced UX with browser recommendations and requirements.
- Task 3.1 COMPLETED: Created authentication server actions using @simplewebauthn/server. Implemented generatePasskeyAuthenticationOptions() to create authentication challenges and verifyPasskeyAuthentication() to verify authentication responses. Added proper credential lookup, counter management, and challenge storage. Server actions handle username validation, credential verification, and user session preparation with proper TypeScript types and error handling.
- Task 3.2 COMPLETED: Implemented frontend navigator.credentials.get() functionality for passkey authentication. Created PasskeyAuthentication component using ShadCN/ui components (Button, Input, Form, Card, Label, Alert) and @simplewebauthn/browser.startAuthentication(). Added comprehensive browser compatibility checking, WebAuthN error handling with user-friendly messages, mobile-optimized interface, and proper form validation. Component integrates with authentication server actions and provides loading states and error feedback.
- Task 3.3 COMPLETED: Passkey credential verification already implemented in verifyPasskeyAuthentication server action. Function verifies authentication response against stored credentials, validates challenge, origin, and RPID, updates credential counter, and returns verification status. Implementation at src/actions/auth.ts:351-366.
- Task 4 COMPLETED: Verified all required ShadCN/ui components are properly installed and configured. All components (Button, Input, Form, Card, Label, Alert) are available and working correctly. Loading states implemented using Loader2 from lucide-react. TypeScript compilation and imports verified successful.

### File List
- **Modified**: src/payload/collections/product-users.ts - Added webauthnChallenge field and registrationDate field for passkey credentials
- **Modified**: src/types/auth.ts - Extended with WebAuthN types and server action response interfaces  
- **Modified**: src/actions/auth.ts - Implemented WebAuthN passkey registration and authentication server actions
- **Modified**: src/components/auth/passkey-registration.tsx - Frontend passkey registration component with ShadCN/ui integration and browser compatibility checks
- **Created**: tests/components/auth/passkey-registration.test.tsx - Unit tests for passkey registration component
- **Created**: src/components/auth/passkey-authentication.tsx - Frontend passkey authentication component with ShadCN/ui integration and browser compatibility checks
- **Modified**: package.json - Added @simplewebauthn/server, @simplewebauthn/browser, and ShadCN/ui dependencies
- **Modified**: vitest.setup.ts - Added @testing-library/jest-dom for enhanced test matchers

## QA Results

*Results from QA Agent review will be populated here*