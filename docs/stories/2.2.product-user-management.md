# Story 2.2: Product User Management

## Status
Ready for Development

## Story
**As a** system administrator,
**I want** to manage product users and their passkey authentication data,
**so that** I can track user accounts and ensure proper access control.

## Acceptance Criteria

1. **Product users collection** stores usernames, passkey credentials, authentication status, and user metadata
2. **User creation** automatically creates product user records upon successful passkey registration
3. **User lookup** efficiently finds users by username for authentication
4. **User status tracking** maintains current authentication and account status
5. **Data validation** ensures usernames are properly formatted and unique
6. **User management interface** allows admins to view and manage product users
7. **Security compliance** implements proper data protection for username and passkey credential storage
8. **User session tracking** maintains current user state and authentication status
9. **Error handling** gracefully handles duplicate users and authentication failures
10. **Data integrity** ensures user data consistency across authentication flows

## Tasks / Subtasks

- [ ] Task 1: Verify ProductUsers collection implementation (AC: 1, 5, 7)
  - [ ] Subtask 1.1: Review ProductUsers collection field structure and validation
  - [ ] Subtask 1.2: Verify username uniqueness constraint and validation rules
  - [ ] Subtask 1.3: Validate passkey credentials storage schema and security
  - [ ] Subtask 1.4: Confirm current program and progress tracking fields

- [ ] Task 2: Implement server actions for user management (AC: 2, 3, 4, 8, 9, 10)
  - [ ] Subtask 2.1: Create server action for creating product users during registration
  - [ ] Subtask 2.2: Implement server action for user lookup by username
  - [ ] Subtask 2.3: Add server action for updating user status and session tracking
  - [ ] Subtask 2.4: Implement error handling for duplicate users and auth failures
  - [ ] Subtask 2.5: Add server action for tracking authentication status changes

- [ ] Task 3: Enhance admin interface for user management (AC: 6)
  - [ ] Subtask 3.1: Configure PayloadCMS admin UI for ProductUsers collection
  - [ ] Subtask 3.2: Set up admin columns and display configuration
  - [ ] Subtask 3.3: Implement search and filtering capabilities
  - [ ] Subtask 3.4: Add user status indicators and metadata display

- [ ] Task 4: Integrate with authentication workflow (AC: 2, 3, 4, 8)
  - [ ] Subtask 4.1: Update registration flow to create ProductUser records
  - [ ] Subtask 4.2: Update authentication flow to use user lookup
  - [ ] Subtask 4.3: Implement session state management and tracking
  - [ ] Subtask 4.4: Add authentication status updates

- [ ] Task 5: Testing and validation (AC: 9, 10)
  - [ ] Subtask 5.1: Write unit tests for user management server actions
  - [ ] Subtask 5.2: Test admin interface user management capabilities
  - [ ] Subtask 5.3: Test error handling for edge cases and conflicts
  - [ ] Subtask 5.4: Validate data integrity across authentication workflows

## Dev Notes

### Previous Story Insights
[Source: Story 2.1 Dev Agent Record]

**Key Implementation Details from Story 2.1:**
- ProductUsers collection already exists with comprehensive structure at `src/payload/collections/product-users.ts`
- WebAuthN authentication system fully implemented with @simplewebauthn/server
- JWT token generation and validation system in place at `src/lib/auth.ts`
- Zustand auth store implemented for session management at `src/stores/auth-store.ts`
- Authentication server actions implemented at `src/actions/auth.ts`
- Middleware authentication and rate limiting already configured

**Critical Dependencies Already Available:**
- @simplewebauthn/server: WebAuthN operations
- jsonwebtoken: JWT token management
- Zustand: State management with persistence
- Zod: Schema validation for auth inputs

### PayloadCMS Collection Architecture
[Source: architecture/payloadcms-collections.md#ProductUsers]

**ProductUsers Collection Structure:**
- Location: `src/payload/collections/product-users.ts`
- Admin access controls: Only authenticated admin users can manage product users
- Username validation: 3-20 characters, alphanumeric and underscores only
- Passkey credentials: Array field with credentialID, publicKey, counter, deviceType, backedUp, transports, registrationDate
- Progress tracking: currentProgram, currentMilestone, currentDay, lastWorkoutDate, totalWorkoutsCompleted
- Admin interface: useAsTitle='username', defaultColumns include username, currentProgram, currentMilestone, currentDay

**Security and Access Controls:**
- Complete separation between PayloadCMS admin users and product users
- Product users use WebAuthN authentication only (no PayloadCMS auth)
- Admin users can view and manage product users through PayloadCMS interface
- Secure passkey credential storage with proper WebAuthN field structure

### Backend Architecture Patterns
[Source: architecture/backend-architecture.md]

**Server Action Template Pattern:**
```typescript
'use server'
import { getPayload } from 'payload'
import { getCurrentProductUser } from '@/lib/auth'
import { validateData } from '@/lib/validation'
import { revalidatePath } from 'next/cache'

export async function serverActionName(data: ActionData) {
  try {
    // Authentication/Authorization
    // Validation using Zod schemas
    // Business logic with PayloadCMS Local API
    // Revalidate relevant paths
    return { success: true, data: result }
  } catch (error) {
    console.error('Server Action Error:', error)
    return { success: false, error: error.message }
  }
}
```

**PayloadCMS Local API Usage:**
- Use `getPayload()` for database operations
- Use `payload.find()`, `payload.create()`, `payload.update()` methods
- Full TypeScript type safety automatically provided
- No raw MongoDB queries - use PayloadCMS abstraction

### File Locations and Structure
[Source: architecture/unified-project-structure.md]

**Server Actions:**
- Authentication actions: `src/actions/auth.ts` (already implemented)
- Additional admin actions: Add to existing auth.ts or create admin-specific actions

**Type Definitions:**
- Auth types: `src/types/auth.ts` (already implemented)
- Extend existing types for admin functionality

**Admin Interface:**
- PayloadCMS collection: `src/payload/collections/product-users.ts` (already exists)
- Admin UI configuration already in place

### Technology Stack Requirements
[Source: architecture/tech-stack.md]

**Critical Dependencies (Already Installed):**
- PayloadCMS 3.53+: Admin interface and data management
- Zod 4.1+: Schema validation and type safety
- WebAuthN/FIDO2: Passkey authentication (already implemented)
- TypeScript 5.3+: Type-safe development

**Coding Standards:**
[Source: architecture/coding-standards.md]
- File names: kebab-case (product-user-management.ts)
- Server actions: camelCase function names
- Type sharing: Define types in `src/types/` and import
- Error handling: Proper error handling with Zod validation
- Environment variables: Access through config objects only

### Testing

**Testing Standards**
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Backend tests: `tests/actions/auth.test.ts` (extend existing)
- PayloadCMS tests: `tests/payload/collections.test.ts`
- Admin interface: No testing required for PayloadCMS UI (framework already tested)

**Testing Framework:**
- Backend: Vitest for server actions testing
- Focus on custom business logic validation
- DO NOT test PayloadCMS collection configurations (framework already tested)
- DO test custom data processing and validation logic
- DO test server action integration with PayloadCMS data

**Testing Philosophy:**
- Test custom business logic and validation functions
- Test integration points between our code and PayloadCMS
- Skip testing PayloadCMS framework functionality
- Focus on Story 2.2 specific user management operations

**Story-Specific Test Cases:**
- Test user creation during registration workflow
- Test user lookup by username functionality
- Test user status tracking and authentication state management
- Test error handling for duplicate users and authentication failures
- Test admin interface user management capabilities (integration tests)
- Test data integrity across authentication workflows

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 1.0 | Initial story creation with comprehensive architecture context and ProductUsers collection analysis | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results

*Results from QA Agent review will be populated here*
