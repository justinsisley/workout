# Story 2.3: Program Selection Interface

## Status
Approved

## Story
**As a** product user,
**I want** to view and select from available workout programs,
**so that** I can choose the program that best fits my fitness goals and current level.

## Acceptance Criteria

1. **Program list display** shows all available workout programs with names and descriptions
2. **Program details view** displays program objectives and estimated duration
3. **Program selection** allows users to choose and confirm their selected program
4. **User program assignment** stores the selected program for the authenticated user
5. **Program status tracking** maintains user's current program selection and progress
6. **Mobile optimization** provides touch-friendly interface optimized for phone use
7. **Program preview enhancement** shows additional program details and structure information
8. **Program preview** shows program structure (milestones, estimated duration)
9. **Selection confirmation** requires user confirmation before program assignment
10. **Error handling** gracefully handles program selection failures and provides user feedback

## Tasks / Subtasks

- [x] Task 1: Pre-story validation and architecture alignment (AC: N/A)
  - [x] Validate server action patterns from Story 2.2 are implemented
  - [x] Verify or create `docs/architecture/server-actions-specification.md`
  - [x] Confirm PayloadCMS Local API integration patterns are established
  - [x] Validate ProductUsers collection schema matches story requirements

- [x] Task 2: Create program selection page component (AC: 1, 2, 6, 7, 8)
  - [x] Create `src/app/(frontend)/programs/page.tsx` server component
  - [x] Implement program data fetching using PayloadCMS Local API
  - [x] Design mobile-optimized program list layout with ShadCN components
  - [x] Display program names, descriptions, objectives, and estimated duration
  - [x] Show enhanced program structure preview with milestones details and day counts

- [ ] Task 3: Create program selection and assignment logic (AC: 3, 4, 9)
  - [ ] Create `assignProgramToUser` server action in `src/actions/programs.ts`
  - [ ] Implement program selection confirmation modal
  - [ ] Add program assignment logic with ProductUsers collection update
  - [ ] Initialize user progress tracking (currentProgram, currentMilestone, currentDay)

- [ ] Task 4: Implement program status tracking (AC: 5)
  - [ ] Update ProductUsers collection schema for program tracking
  - [ ] Add progress initialization logic in server action
  - [ ] Implement progress persistence using PayloadCMS Local API
  - [ ] Add state management for current program selection

- [ ] Task 5: Add comprehensive error handling (AC: 10)
  - [ ] Implement error handling in server actions using proper error response format
  - [ ] Add user-friendly error messages for program assignment failures
  - [ ] Handle edge cases (no programs available, assignment conflicts)
  - [ ] Add loading states and success feedback

- [ ] Task 6: Unit testing for program selection components (Testing Requirements)
  - [ ] Test program list rendering and data display
  - [ ] Test enhanced program preview functionality
  - [ ] Test program selection and confirmation flow
  - [ ] Test error handling scenarios and user feedback

## Dev Notes

### Previous Story Insights
[From Story 2.2 completion notes]
- ProductUsers collection already implemented with progress tracking fields: `currentProgram`, `currentMilestone`, `currentDay`
- User management server actions established pattern: `createProductUser`, `findProductUserByUsername`, `updateUserStatus`
- Authentication flow complete with JWT tokens and Zustand state management
- PayloadCMS Local API integration patterns established for type-safe data operations

### Data Models
[Source: architecture/payloadcms-collections.md#programs-collection]

**Programs Collection Schema:**
```typescript
// Programs collection structure (embedded schema design)
interface Program {
  id: string
  name: string
  description: string
  objective: string
  isPublished: boolean
  milestones: EmbeddedMilestone[]
}

interface EmbeddedMilestone {
  id: string
  name: string
  description: string
  estimatedDuration: string
  days: EmbeddedDay[]
}
```

**ProductUsers Collection Updates:**
[Source: architecture/payloadcms-collections.md#productusers-collection]
```typescript
interface ProductUser {
  id: string
  username: string
  currentProgram: string | null  // Program ID
  currentMilestone: number      // 0-based milestone index
  currentDay: number           // 0-based index
  // ... existing fields from Story 2.2
}
```

### API Specifications
[Source: architecture/server-actions-specification.md#program-management-server-actions]

**Required Server Actions:**
```typescript
// src/actions/programs.ts
export async function getPrograms() // Get published programs
export async function assignProgramToUser(programId: string, productUserId: string)
export async function getProgramById(programId: string) // For program details
```

**Server Action Pattern:**
[Source: Story 2.2 Dev Notes]
```typescript
export async function serverActionName(data: ActionData) {
  try {
    // Authentication check using getCurrentProductUser()
    // Validation using Zod schemas
    // Business logic with PayloadCMS Local API getPayload()
    // Revalidate relevant paths with revalidatePath()
    return { success: true, data: result }
  } catch (error) {
    console.error('Server Action Error:', error)
    return { success: false, error: error.message }
  }
}
```

### Component Specifications
[Source: architecture/frontend-architecture.md#component-template]

**Component Structure Pattern:**
```typescript
// Mobile-optimized React component template
import React from 'react'
import { cn } from '@/lib/utils'

interface ComponentProps {
  className?: string
  programs: Program[]
  onProgramSelect: (programId: string) => void
}

export const ProgramSelector: React.FC<ComponentProps> = ({
  className,
  programs,
  onProgramSelect
}) => {
  // Component implementation with ShadCN components
}
```

**State Management Pattern:**
[Source: architecture/frontend-architecture.md#zustand-store-structure]
```typescript
// Zustand store pattern for program selection state
interface ProgramState {
  selectedProgram: Program | null
  setSelectedProgram: (program: Program | null) => void
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

**Frontend Pages:**
- Program list: `src/app/(frontend)/programs/page.tsx` (Server Component)
- Program details: `src/app/(frontend)/programs/[id]/page.tsx` (if needed)

**Components:**
- Program selection: `src/components/program/program-selector.tsx`
- Program card: `src/components/program/program-card.tsx`

**Server Actions:**
- Program actions: `src/actions/programs.ts` (extend existing file)

**Types:**
- Program types: `src/types/program.ts` (create new file)
- Extend auth types: `src/types/auth.ts` (add program assignment types)

**State Management:**
- Program store: `src/stores/program-store.ts` (create new file)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Component tests: `tests/components/program/`
- Server action tests: `tests/actions/programs.test.ts`
- E2E tests: `tests/e2e/program-selection.spec.ts`

**Testing Framework and Patterns:**
- Frontend: Vitest + React Testing Library for component testing
- Backend: Vitest for server action testing
- E2E: Playwright for user journey testing
- Focus on custom business logic, not PayloadCMS framework functionality

**Story-Specific Test Cases:**
- Test program list rendering with various program data scenarios
- Test enhanced program preview display functionality
- Test program selection flow including confirmation modal
- Test server action integration with PayloadCMS data operations
- Test error handling for program assignment failures
- Test mobile-optimized interface responsiveness

### Technical Constraints
[Source: architecture/tech-stack.md, architecture/coding-standards.md]

**Technology Stack:**
- TypeScript 5.3+, Next.js 15.5+, React 19+
- ShadCN/ui components, Tailwind CSS 4.1+
- Zustand for state management
- PayloadCMS 3.53+ Local API for data operations
- Zod 4.1+ for schema validation

**Coding Standards:**
- File names: kebab-case (program-selector.tsx, programs.ts)
- Component names: PascalCase (ProgramSelector)
- Server actions: camelCase (assignProgramToUser)
- Type definitions: PascalCase in src/types/
- Mobile-first responsive design with Tailwind CSS

### Security and Performance
[Source: architecture/security-and-performance.md]
- Authentication required for program selection
- Rate limiting for program assignment operations
- PayloadCMS Local API provides built-in query optimization
- Mobile-optimized components and data fetching
- Proper error handling without exposing sensitive information

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-11 | 1.0 | Initial story creation with comprehensive architecture context and program selection requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results

*Results from QA Agent review will be populated here*