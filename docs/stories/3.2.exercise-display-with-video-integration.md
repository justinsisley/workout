# Story 3.2: Exercise Display with Video Integration

## Status
Ready for Development

## Story
**As a** product user,  
**I want** to view exercise details with video demonstrations,  
**so that** I can perform exercises correctly with proper form and technique.

## Acceptance Criteria

1. **Exercise detail screen** displays exercise name, description, instructions, time duration in natural format when applicable, and distance in natural format when applicable, with round-based presentation for AMRAP exercises
2. **Video integration** shows exercise demonstration videos with inline playback
3. **AMRAP exercise context** clearly indicates when exercise is part of an AMRAP round with round progression display
4. **Fullscreen video toggle** allows users to view videos in fullscreen mode
5. **Video controls** provide play, pause, and seek functionality for exercise videos
6. **Mobile optimization** ensures smooth video playback on mobile devices
7. **Video loading states** provides feedback during video loading and buffering
8. **Alternative video sources** handles video loading failures with fallback options
9. **Touch-friendly controls** optimizes video controls for touch interaction
10. **Video performance** ensures minimal buffering and smooth playback during gym use
11. **Accessibility** provides alternative text and descriptions for video content

## Tasks / Subtasks

1. [x] Create exercise detail page component (AC: 1, 2, 11)
   1.1. [x] Implement `src/app/(frontend)/workout/exercise/[id]/page.tsx` as server component
   1.2. [x] Add authentication middleware for protected routes
   1.3. [x] Fetch exercise data using PayloadCMS Local API with populated relationships
   1.4. [x] Display exercise name, description, and instructions with mobile-optimized typography
   1.5. [x] Integrate natural format display for duration and distance using existing utilities

2. [x] Add exercise navigation and routing (AC: 1)
   2.1. [x] Implement dynamic routing for individual exercise pages
   2.2. [x] Add navigation between exercises within a workout day
   2.3. [x] Integrate with existing workout store for exercise progression
   2.4. [x] Add breadcrumb navigation for current exercise position
   2.5. [x] Implement back navigation to workout dashboard

3. [x] Build YouTube video integration component (AC: 2, 4, 5, 8)
   3.1. [x] Create `src/components/workout/exercise-video.tsx` component
   3.2. [x] Implement YouTube iframe API integration for video playback
   3.3. [x] Add fullscreen video toggle functionality
   3.4. [x] Implement video controls (play, pause, seek) using YouTube API
   3.5. [x] Add video loading failure handling with fallback UI
   3.6. [x] Extract YouTube video ID from exercise.videoUrl field

4. [x] Add AMRAP context display component (AC: 1, 3)
   4.1. [x] Create `src/components/workout/exercise-amrap-context.tsx` component
   4.2. [x] Use `isAmrapDay` type guard to detect AMRAP workout context
   4.3. [x] Display round-based presentation for AMRAP exercises
   4.4. [x] Show current round progression and total rounds completed
   4.5. [x] Integrate with existing workout store for AMRAP session state

5. [ ] Implement mobile-optimized video controls (AC: 6, 9, 10)
   5.1. [ ] Create touch-friendly video control interface with 44px minimum touch targets
   5.2. [ ] Add mobile-specific video performance optimizations
   5.3. [ ] Implement smooth video playback controls for gym use
   5.4. [ ] Add responsive design patterns using Tailwind mobile-first approach
   5.5. [ ] Integrate touch-manipulation CSS for better touch responsiveness

6. [ ] Add video loading states and feedback (AC: 7)
   6.1. [ ] Create `src/components/workout/video-loading-state.tsx` component
   6.2. [ ] Implement loading spinners and buffering indicators
   6.3. [ ] Add error states for video loading failures
   6.4. [ ] Provide user feedback during video loading processes
   6.5. [ ] Use ShadCN UI components for consistent loading state design

7. [ ] Implement accessibility features (AC: 11)
   7.1. [ ] Add alternative text and descriptions for video content
   7.2. [ ] Implement keyboard navigation support for video controls
   7.3. [ ] Add screen reader compatibility for exercise descriptions
   7.4. [ ] Include ARIA labels for video player controls
   7.5. [ ] Ensure proper focus management for mobile and desktop users

8. [ ] Create comprehensive unit tests for exercise display components (AC: All)
   8.1. [ ] Test exercise detail page with various exercise types
   8.2. [ ] Test YouTube video integration with mock video data
   8.3. [ ] Test AMRAP context display with round progression
   8.4. [ ] Test mobile optimization and touch interactions
   8.5. [ ] Test accessibility features and keyboard navigation

## Dev Notes

**Previous Story Insights:** [Source: 3.1 completion notes]
- Zustand workout store is already implemented with session management, exercise navigation, and AMRAP round tracking
- Mobile-first responsive design patterns established using Tailwind CSS with 44px touch targets
- ShadCN UI components (badge, progress, alert-dialog) are already available and configured
- Existing formatting utilities (`formatDistance`, `formatDuration`) should be used for natural time/distance display
- Type guards (`isAmrapDay`, `hasDistance`, `hasDuration`) are available for conditional rendering
- Testing framework is established with Vitest + Testing Library with comprehensive test patterns

**Data Models:** [Source: architecture/payloadcms-collections.md#exercises-collection]
- **Exercise Collection Structure:**
  ```typescript
  interface Exercise {
    id: string
    title?: string // Exercise name
    description?: string // Exercise description and instructions
    videoUrl?: string // YouTube video URL
    alternatives: string[] // Alternative exercise references
    createdAt: Date
    updatedAt: Date
  }
  ```
- **Exercise Configuration in Programs:** [Source: architecture/payloadcms-collections.md#programs-collection]
  ```typescript
  interface ExerciseConfig {
    exercise: string // Reference to Exercise ID
    sets: number
    reps: number
    restPeriod?: number // Rest time between sets (seconds)
    weight?: number // Weight to use (lbs)
    durationValue?: number // Duration numeric value (e.g., 1, 30, 5)
    durationUnit?: 'seconds' | 'minutes' | 'hours' // Duration time unit
    notes?: string // Additional instructions
  }
  ```

**Video Integration:** [Source: architecture/components.md#video-integration-components]
- **YouTube Integration Requirements:**
  - Use YouTube iframe API for video embedding and playback
  - Extract video ID from YouTube URLs in exercise.videoUrl field
  - Implement responsive video player with mobile optimization
  - Handle video loading failures with fallback UI
  - Provide play, pause, and seek controls through YouTube API

**File Locations:** [Source: architecture/unified-project-structure.md]
- Exercise detail page: `src/app/(frontend)/workout/exercise/[id]/page.tsx`
- Exercise components: `src/components/workout/exercise-*.tsx`
- Video components: `src/components/workout/*-video.tsx`
- Test files: `tests/components/workout/exercise-*.test.tsx`

**State Management:** [Source: architecture/frontend-architecture.md#zustand-store-structure]
- **Workout Store Interface:**
  ```typescript
  interface WorkoutState {
    currentProgram: Program | null
    currentMilestoneIndex: number
    currentDayIndex: number
    currentExerciseIndex: number
    completedExercises: string[]
    sessionStartTime: Date | null
    // Navigation helpers already available:
    getCurrentDay: () => EmbeddedDay | null
    getCurrentExercise: () => Exercise | null
    setCurrentExercise: (exerciseIndex: number) => void
    completeExercise: (exerciseId: string) => void
  }
  ```

**UI Component Integration:** [Source: architecture/frontend-architecture.md#component-template]
- Use ShadCN UI components for consistent design
- Follow established component template with TypeScript interfaces
- Implement mobile-first responsive design with Tailwind CSS
- Use `cn()` utility for conditional class merging
- Apply 44px minimum touch targets for mobile optimization

**Data Access Pattern:** [Source: architecture/frontend-architecture.md#server-component-data-fetching]
- Server components should use PayloadCMS Local API for data fetching
- Use `getPayload()` to access PayloadCMS SDK in server components
- Fetch exercises with populated relationships for complete data
- Client components use server actions for data mutations

**Routing Integration:** [Source: architecture/frontend-architecture.md#route-organization]
- Exercise detail pages use dynamic routing: `/workout/exercise/[id]`
- Implement protected route authentication using `getCurrentProductUser()`
- Add navigation integration with existing workout dashboard and day overview

**Mobile Optimization Requirements:** [Source: 3.1 completion notes]
- Apply mobile-first responsive design patterns across all components
- Use larger touch targets (44px minimum) for touch-friendly interactions
- Implement high-contrast colors and improved visual hierarchy for gym visibility
- Add touch-manipulation CSS for reduced input delays on mobile devices
- Use responsive breakpoints (sm:, lg:) for optimal display across devices

**Coding Standards:** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Use kebab-case for all file names (strictly enforced)
- Server actions for data mutations, PayloadCMS Local API for queries
- Type sharing from `src/types/` directory
- Proper error handling with Zod validation

## Testing

**Test File Locations:** `tests/components/workout/exercise-*.test.tsx` [Source: architecture/testing-strategy.md#test-organization]

**Testing Standards:**
- Use Vitest + Testing Library for component unit tests
- Focus on business logic: video integration, AMRAP context display, mobile interactions
- Mock YouTube iframe API and PayloadCMS data structures
- Test mobile-optimized UI interactions and touch-friendly elements
- Test accessibility features including keyboard navigation and screen reader support

**Key Test Scenarios:**
- Exercise data display with various exercise types (time-based, weight-based, bodyweight)
- YouTube video integration including loading states and error handling
- AMRAP context detection and round-based progression display
- Mobile optimization including touch interactions and responsive design
- Video controls functionality (play, pause, seek, fullscreen)
- Accessibility features including keyboard navigation and ARIA labels
- Exercise navigation and routing between exercises in a workout day
- Error handling for missing exercise data or video loading failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

claude-sonnet-4-20250514

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

- **Task 1 Completed**: Exercise detail page component implemented with server-side authentication, PayloadCMS data fetching, and mobile-optimized responsive design
- **Search Params Integration**: Exercise configuration (sets, reps, weight, duration, distance) can be passed via URL search parameters for workout context
- **Natural Formatting**: Duration and distance formatting using existing utilities (`formatDuration`, `formatDistance`) for natural language display
- **Mobile Optimization**: Applied 44px touch targets, mobile-first responsive design with Tailwind CSS breakpoints
- **Type Safety**: Full TypeScript integration with PayloadCMS generated types
- **Task 2 Completed**: Exercise navigation and routing fully implemented with workout store integration
- **Navigation Components**: Created `ExerciseNavigation` and `ExerciseBreadcrumb` components with mobile-optimized touch targets
- **Store Integration**: Full integration with Zustand workout store for exercise progression tracking and navigation state
- **Dynamic Routing**: Enhanced dynamic routing with Next.js 15 async params/searchParams pattern
- **URL State Management**: Exercise configuration preserved in URL parameters during navigation between exercises
- **Task 3 Completed**: YouTube video integration component fully implemented with comprehensive functionality
- **Video Integration**: Complete YouTube iframe API integration with video ID extraction from multiple URL formats
- **Custom Controls**: Touch-optimized video controls (play/pause, restart, fullscreen) with 44px minimum touch targets
- **Error Handling**: Robust error handling for video loading failures, API initialization errors, and fallback states
- **Mobile Optimization**: Mobile-first responsive design with touch-manipulation CSS for enhanced touch responsiveness
- **Accessibility**: Full accessibility support with ARIA labels, keyboard navigation, and screen reader compatibility
- **Comprehensive Testing**: 29 passing unit tests covering video integration, controls, error handling, and accessibility
- **Task 4 Completed**: AMRAP context display component fully implemented with round-based presentation and workout store integration
- **AMRAP Detection**: Uses `isAmrapDay` type guard to conditionally render only for AMRAP workout days
- **Round Progression**: Displays current round number, round progress percentage, and exercises completed in current round
- **Completed Rounds**: Shows total completed rounds with visual badges and clear completion indicators
- **Time Management**: Real-time countdown display with warning colors for low time remaining and proper time formatting
- **Visual Design**: Orange-themed UI with appropriate icons (RotateCw, Target, CheckCircle2, Clock) for AMRAP context
- **Error Prevention**: Handles edge cases including zero exercises, undefined exercises, and missing duration values
- **Comprehensive Testing**: 18 passing unit tests covering AMRAP detection, round progression, time display, and error handling

### File List

**New Files:**
- `src/app/(frontend)/workout/exercise/[id]/page.tsx` - Exercise detail page component with server-side rendering and authentication
- `src/components/workout/exercise-navigation.tsx` - Exercise navigation component with workout store integration
- `src/components/workout/exercise-breadcrumb.tsx` - Breadcrumb navigation component for exercise context
- `src/components/workout/exercise-detail-client.tsx` - Client wrapper component for store integration
- `src/components/workout/exercise-video.tsx` - YouTube video integration component with custom controls and error handling
- `src/components/workout/exercise-amrap-context.tsx` - AMRAP context display component with round progression and time tracking
- `tests/components/workout/exercise-video.test.tsx` - Comprehensive unit tests for video component
- `tests/components/workout/exercise-amrap-context.test.tsx` - Comprehensive unit tests for AMRAP context component

**Modified Files:**
- `src/app/(frontend)/workout/exercise/[id]/page.tsx` - Updated with navigation components and Next.js 15 async params pattern
- `src/components/workout/exercise-detail-client.tsx` - Updated with AMRAP context component integration

## QA Results

*Results from QA Agent review will be populated here after implementation.*