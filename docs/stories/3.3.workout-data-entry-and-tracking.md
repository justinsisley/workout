# Story 3.3: Workout Data Entry and Tracking

## Status
Ready for Development

## Story
**As a** product user,  
**I want** to log my workout data (sets, reps, weight, time),  
**so that** I can track my progress and have accurate data for future sessions.

## Acceptance Criteria

1. **Data entry interface** provides easy input for sets, reps, weight, time with time displays in natural format matching admin specification, and distance with distance displays in natural format matching admin specification
2. **AMRAP data tracking** records rounds completed instead of individual set tracking for AMRAP workouts, with total rounds and partial round completion
3. **Auto-population** pre-fills previous workout data for the same exercise
4. **Smart defaults** suggests appropriate values based on previous sessions
5. **Number input optimization** provides touch-friendly number input for gym use
6. **Data validation** ensures entered values are reasonable and within expected ranges
7. **Real-time saving** saves workout data as it's entered to prevent data loss
8. **Progress tracking** updates exercise completion status in real-time, with round-based tracking for AMRAP workouts
9. **Data persistence** stores all workout data to database for future reference
10. **Input error handling** provides clear feedback for invalid data entry
11. **Mobile optimization** ensures one-handed operation during gym use

## Tasks / Subtasks

1. [x] Create workout data entry components (AC: 1, 5, 11)
   1.1. [x] Implement `src/components/workout/workout-data-entry.tsx` component with touch-friendly number inputs
   1.2. [x] Add natural format display for time and distance using existing formatting utilities
   1.3. [x] Create mobile-optimized input controls with 44px minimum touch targets
   1.4. [x] Implement one-handed operation design patterns for gym use
   1.5. [x] Add proper TypeScript interfaces for workout data entry props

2. [x] Build AMRAP-specific data tracking (AC: 2, 8)
   2.1. [x] Create `src/components/workout/amrap-data-entry.tsx` component for round-based tracking
   2.2. [x] Implement round completion tracking instead of individual set tracking
   2.3. [x] Add partial round completion functionality for incomplete AMRAP rounds
   2.4. [x] Integrate with existing AMRAP detection using `isAmrapDay` type guard
   2.5. [x] Add visual indicators for total rounds completed and current round progress

3. [x] Implement auto-population and smart defaults (AC: 3, 4)
   3.1. [x] Create server action `src/actions/exercises.ts::getPreviousExerciseData`
   3.2. [x] Query `exerciseCompletions` collection for user's previous data on same exercise
   3.3. [x] Pre-fill form inputs with previous workout values (sets, reps, weight, time)
   3.4. [x] Implement smart suggestion algorithm based on historical performance
   3.5. [x] Add fallback defaults when no previous data exists

4. [x] Add data validation and error handling (AC: 6, 10)
   4.1. [x] Create Zod validation schemas in `src/utils/validation.ts` for workout data
   4.2. [x] Implement reasonable range validation (weight: 0-1000 lbs, reps: 1-999, etc.)
   4.3. [x] Add real-time input validation with clear error messaging
   4.4. [x] Create user-friendly validation feedback for invalid entries
   4.5. [x] Implement form-level validation before data submission

5. [ ] Build real-time saving and data persistence (AC: 7, 9)
   5.1. [ ] Create server action `src/actions/workouts.ts::saveExerciseCompletion`
   5.2. [ ] Implement auto-save functionality with debounced input changes
   5.3. [ ] Store workout data to `exerciseCompletions` collection with program context
   5.4. [ ] Add loading states and success feedback for save operations
   5.5. [ ] Handle network failures with offline-capable data storage

6. [ ] Integrate with workout store for progress tracking (AC: 8)
   6.1. [ ] Update workout store to track exercise completion status
   6.2. [ ] Add real-time progress updates as workout data is entered
   6.3. [ ] Implement round-based progress tracking for AMRAP workouts
   6.4. [ ] Update exercise navigation to reflect completion status
   6.5. [ ] Sync completion status between data entry and workout dashboard

7. [ ] Add comprehensive unit testing (Testing Requirements)
   7.1. [ ] Create `tests/components/workout/workout-data-entry.test.tsx`
   7.2. [ ] Create `tests/components/workout/amrap-data-entry.test.tsx`
   7.3. [ ] Test auto-population functionality and smart defaults
   7.4. [ ] Test data validation and error handling scenarios
   7.5. [ ] Test real-time saving and progress tracking integration
   7.6. [ ] Test mobile optimization and touch-friendly interactions

## Dev Notes

**Previous Story Insights:**
- Exercise detail page component already implemented with server-side authentication and PayloadCMS data fetching [Source: Story 3.2 completion notes]
- YouTube video integration and AMRAP context display components are available for reference
- Mobile optimization patterns established: 44px touch targets, mobile-first responsive design, touch-manipulation CSS
- Workout store integration patterns established with navigation and exercise progression tracking

**Data Models:** [Source: architecture/payloadcms-collections.md#exercisecompletions-collection]
```typescript
interface ExerciseCompletion {
  id: string
  productUser: string // Reference to ProductUser ID
  exercise: string // Reference to Exercise ID
  program: string // Reference to Program ID
  milestoneIndex: number // Index of milestone within program
  dayIndex: number // Index of day within milestone
  sets: number
  reps: number
  weight?: number // Optional for bodyweight exercises
  time?: number // Optional - not relevant for all exercises
  completedAt: Date
  notes?: string
  createdAt: Date
  updatedAt: Date
}
```

**Exercise Configuration from Programs:** [Source: architecture/payloadcms-collections.md#programs-collection]
```typescript
interface ExerciseConfig {
  exercise: string // Reference to Exercise ID
  sets: number
  reps: number
  restPeriod?: number // Rest time between sets (seconds)
  weight?: number // Weight to use (lbs)
  durationValue?: number // Duration numeric value (e.g., 1, 30, 5)
  durationUnit?: 'seconds' | 'minutes' | 'hours' // Duration time unit
  notes?: string // Additional instructions
}
```

**AMRAP Day Detection:** [Source: architecture/backend-architecture.md#type-safety-patterns]
```typescript
// Use existing type guard for AMRAP day detection
export function isAmrapDay(day: Day): day is Day & { isAmrap: true; amrapDuration: number } {
  return Boolean(day.isAmrap && day.amrapDuration)
}
```

**File Locations:** [Source: architecture/unified-project-structure.md]
- Workout data entry components: `src/components/workout/workout-data-entry.tsx`, `src/components/workout/amrap-data-entry.tsx`
- Server actions: `src/actions/workouts.ts`, `src/actions/exercises.ts`
- Data validation: `src/utils/validation.ts`
- Test files: `tests/components/workout/workout-data-entry.test.tsx`, `tests/components/workout/amrap-data-entry.test.tsx`

**State Management:** [Source: architecture/frontend-architecture.md#zustand-store-structure]
```typescript
// Workout store interface already available:
interface WorkoutState {
  currentProgram: Program | null
  currentMilestoneIndex: number
  currentDayIndex: number
  currentExerciseIndex: number
  completedExercises: string[]
  sessionStartTime: Date | null
  // Methods for exercise completion tracking:
  completeExercise: (exerciseId: string) => void
  getCurrentDay: () => EmbeddedDay | null
  getCurrentExercise: () => Exercise | null
}
```

**Data Access Pattern:** [Source: architecture/backend-architecture.md#payloadcms-local-api-data-access]
- Server components should use PayloadCMS Local API for data fetching
- Use `getPayload()` to access PayloadCMS SDK in server actions
- Query `exerciseCompletions` collection for previous workout data
- Client components use server actions for data mutations

**Natural Format Display:** [Source: architecture/frontend-architecture.md#display-utilities-architecture]
```typescript
// Use existing formatting utilities
import { formatDistance, formatDuration } from '@/utils/formatters'

// formatDistance(20, 'meters') → "20 meters"
// formatDistance(1, 'miles') → "1 mile"
// formatDuration(30, 'seconds') → "30 seconds"
// formatDuration(1, 'hours') → "1 hour"
```

**Mobile Optimization Requirements:** [Source: Story 3.1 completion notes]
- Apply mobile-first responsive design patterns across all components
- Use larger touch targets (44px minimum) for touch-friendly interactions
- Implement high-contrast colors and improved visual hierarchy for gym visibility
- Add touch-manipulation CSS for reduced input delays on mobile devices
- Use responsive breakpoints (sm:, lg:) for optimal display across devices
- Ensure one-handed operation capability for gym environment

**Coding Standards:** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Use kebab-case for all file names (strictly enforced)
- Server actions for data mutations, PayloadCMS Local API for queries
- Type sharing from `src/types/` directory
- Proper error handling with Zod validation
- Always use Zustand stores for global state management

## Testing

**Test File Locations:** `tests/components/workout/workout-data-entry.test.tsx`, `tests/components/workout/amrap-data-entry.test.tsx` [Source: architecture/testing-strategy.md#test-organization]

**Testing Standards:**
- Use Vitest + Testing Library for component unit tests
- Focus on business logic: data entry validation, auto-population, real-time saving, AMRAP tracking
- Mock PayloadCMS data structures and server actions
- Test mobile-optimized UI interactions and touch-friendly elements
- Test form validation and error handling scenarios

**Key Test Scenarios:**
- Workout data entry with various exercise types (weight-based, time-based, distance-based, bodyweight)
- AMRAP round tracking including partial round completion and total round display
- Auto-population functionality with previous workout data and smart defaults
- Real-time saving and data persistence including network failure scenarios
- Input validation and error handling for out-of-range values
- Mobile optimization including touch interactions and one-handed operation
- Integration with workout store for progress tracking and exercise completion status
- Natural format display for time and distance values matching admin specifications

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
Claude Sonnet 4 (20250514)

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

**Task 1 Implementation Completed:**
- ✅ Created `WorkoutDataEntry` component with comprehensive mobile-first design
- ✅ Implemented touch-friendly number inputs with 44px minimum touch targets
- ✅ Added natural format display for time and distance using existing `formatters.ts` utilities
- ✅ Integrated proper TypeScript interfaces with strict typing for all props and data
- ✅ Built-in data validation with real-time error feedback and range checking
- ✅ Applied mobile optimization patterns: touch-manipulation CSS, large inputs, one-handed operation
- ✅ Implemented auto-population functionality with smart defaults from exercise config
- ✅ Added conditional field display based on exercise requirements (weight, time, distance)
- ✅ Created comprehensive unit test suite with 20 test cases covering all functionality
- ✅ Ensured linting compliance and code quality standards

**Task 2 Implementation Completed:**
- ✅ Created `AmrapDataEntry` component with round-based tracking for AMRAP workouts
- ✅ Implemented total rounds completed tracking with increment/decrement buttons
- ✅ Added partial round completion functionality with exercise-level detail tracking
- ✅ Integrated with existing AMRAP detection using `isAmrapDay` type guard
- ✅ Built comprehensive visual indicators: progress bars, completion percentages, session time
- ✅ Created `ExerciseDataEntryClient` to handle conditional rendering (AMRAP vs regular workouts)
- ✅ Integrated AMRAP and regular data entry into exercise detail page
- ✅ Applied mobile-first design with touch-friendly interactions (44px buttons)
- ✅ Added real-time validation with range checking for rounds and exercises
- ✅ Created comprehensive unit test suite with 20+ test cases covering AMRAP functionality
- ✅ Fixed all TypeScript type issues and ensured linting compliance

**Task 3 Implementation Completed:**
- ✅ Created comprehensive server action `getPreviousExerciseData` in `src/actions/exercises.ts`
- ✅ Implemented PayloadCMS integration to query `exerciseCompletions` collection for user's exercise history
- ✅ Built smart suggestion algorithm with progressive overload logic and confidence scoring
- ✅ Added automatic pre-fill functionality for form inputs with previous workout values
- ✅ Implemented fallback defaults using exercise configuration when no previous data exists
- ✅ Created visual indicators showing data source (Previous Data, Smart Defaults, Program Default)
- ✅ Added loading states and proper error handling for data fetching operations
- ✅ Integrated comprehensive TypeScript types with proper optional property handling
- ✅ Applied mobile-first design with disabled inputs during data loading
- ✅ Achieved full linting and TypeScript compliance with no errors

**Task 4 Implementation Completed:**
- ✅ Created comprehensive Zod validation schemas in `src/utils/validation.ts` for all workout data types
- ✅ Implemented strict range validation: sets (1-99), reps (1-999), weight (0-1000 lbs), time/distance (0-999), notes (max 500 chars)
- ✅ Added real-time field validation with `validateWorkoutField` and `validateAmrapField` utility functions
- ✅ Created user-friendly validation feedback with clear, specific error messages for all invalid inputs
- ✅ Implemented comprehensive form-level validation using `validateWorkoutDataEntry` and `validateAmrapDataEntry` functions
- ✅ Updated both `WorkoutDataEntry` and `AmrapDataEntry` components to use new Zod-based validation system
- ✅ Added input sanitization functionality with `sanitizeWorkoutInput` to prevent XSS and ensure data consistency
- ✅ Integrated real-time validation feedback in component UIs with error state display and character counters
- ✅ Created comprehensive test suite covering all validation scenarios including boundary conditions and security tests
- ✅ Achieved full TypeScript compliance and linting standards with proper error handling throughout

### File List

**New Files Created:**
- `src/components/workout/workout-data-entry.tsx` - Main workout data entry component
- `tests/components/workout/workout-data-entry.test.tsx` - Comprehensive unit tests (20 test cases)
- `src/components/workout/amrap-data-entry.tsx` - AMRAP-specific data entry with round tracking
- `tests/components/workout/amrap-data-entry.test.tsx` - Comprehensive AMRAP unit tests (20+ test cases)
- `src/components/workout/exercise-data-entry-client.tsx` - Client wrapper for conditional data entry
- `src/actions/exercises.ts` - Server actions for exercise data retrieval and auto-population

**Modified Files:**
- `src/app/(frontend)/workout/exercise/[id]/page.tsx` - Integrated data entry components
- `src/types/program.ts` - Enhanced type definitions with exercise completion and auto-population types
- `src/components/workout/workout-data-entry.tsx` - Enhanced with auto-population and smart defaults functionality

## QA Results

*Results from QA Agent review will be populated here after implementation.*