# Story 2.4: User Progress Initialization

## Status
Approved

## Story
**As a** product user,
**I want** my progress to be properly initialized when I select a program,
**so that** I can begin my fitness journey from the correct starting point.

## Acceptance Criteria

1. **Progress initialization** sets user's current program, milestone, and day to starting values
2. **Program structure validation** ensures selected program has valid structure before assignment
3. **User progress tracking** maintains current position within selected program
4. **Progress persistence** saves user progress data to database for future sessions
5. **Program completion tracking** enables tracking of overall program progress
6. **Milestone progression** allows users to advance through program milestones
7. **Day progression** enables users to move through program days and exercises
8. **Progress validation** ensures user progress data is consistent with program structure
9. **Error handling** gracefully handles program structure issues and progress conflicts
10. **Data integrity** maintains consistent user progress data across all operations

## Tasks / Subtasks

- [x] Task 1: Validate and enhance progress initialization logic (AC: 1, 2, 8)
  - [x] Review existing `assignProgramToUser` server action progress initialization
  - [x] Add comprehensive program structure validation before assignment
  - [x] Ensure proper 0-based indexing for milestone and day tracking
  - [x] Validate program has at least one milestone with at least one day
  - [x] Add validation for program publishedStatus before assignment

- [x] Task 2: Implement milestone and day progression server actions (AC: 6, 7, 3)
  - [x] Create `advanceToNextDay` server action with validation
  - [x] Create `advanceToNextMilestone` server action with validation
  - [x] Add boundary checks for day and milestone progression
  - [x] Implement automatic milestone progression when day count exceeds milestone days
  - [x] Add program completion detection and status updates

- [x] Task 3: Create comprehensive progress tracking utilities (AC: 4, 5, 10)
  - [x] Create progress calculation utilities in `src/utils/progress.ts`
  - [x] Add program completion percentage calculation
  - [x] Add milestone progress calculation
  - [x] Add overall program progress analytics
  - [x] Add progress consistency validation utilities

- [x] Task 4: Implement progress persistence and state management (AC: 4, 3)
  - [x] Enhance existing program store with progress tracking state
  - [x] Add progress synchronization with database
  - [x] Implement optimistic updates for progress changes
  - [x] Add progress state persistence across app sessions
  - [x] Create progress state rehydration on app initialization

- [x] Task 5: Add comprehensive error handling and validation (AC: 9, 10)
  - [x] Enhance server actions with detailed progress validation errors
  - [x] Add user-friendly error messages for progress conflicts
  - [x] Handle edge cases (corrupted progress, program structure changes)
  - [x] Add rollback mechanisms for failed progress updates
  - [x] Implement data integrity checks and repair mechanisms

- [ ] Task 6: Unit testing for progress initialization and tracking (Testing Requirements)
  - [ ] Test progress initialization with various program structures
  - [ ] Test milestone and day advancement logic with boundary conditions
  - [ ] Test progress calculation utilities with edge cases
  - [ ] Test error handling scenarios and data integrity validation
  - [ ] Test state management and persistence functionality

## Dev Notes

### Previous Story Insights
[From Story 2.3 completion notes]
- Progress tracking infrastructure already established in ProductUsers collection with 0-based indexing
- Server action `assignProgramToUser` exists with basic progress initialization (milestone=0, day=0)
- Progress tracking fields: `currentProgram`, `currentMilestone` (number), `currentDay` (number)
- PayloadCMS Local API integration patterns established for type-safe data operations
- Program store created with Zustand for client-side state management with persistence
- Server action `updateUserProgress` exists for basic progress advancement

### Data Models
[Source: architecture/payloadcms-collections.md#productusers-collection]

**ProductUsers Collection Progress Fields:**
```typescript
interface ProductUser {
  id: string
  username: string
  currentProgram: string | null  // Program ID reference
  currentMilestone: number      // 0-based milestone index within program
  currentDay: number           // 0-based day index within milestone
  lastWorkoutDate?: Date
  totalWorkoutsCompleted: number
  // ... existing authentication fields
}
```

**Programs Collection Embedded Structure:**
[Source: architecture/payloadcms-collections.md#programs-collection]
```typescript
interface Program {
  id: string
  name: string
  description: string
  objective: string
  isPublished: boolean
  milestones: {
    name: string
    theme: string
    objective: string
    days: {
      dayType: 'workout' | 'rest'
      exercises?: ProgramExercise[]
      restNotes?: string
    }[]
  }[]
}
```

### API Specifications
[Source: architecture/server-actions-specification.md#program-management-server-actions]

**Existing Server Actions to Enhance:**
```typescript
// src/actions/programs.ts
export async function assignProgramToUser(programId: string, productUserId: string)
export async function updateUserProgress(productUserId: string, milestone: number, day: number)
```

**New Server Actions to Implement:**
```typescript
// src/actions/programs.ts
export async function advanceToNextDay(productUserId: string)
export async function advanceToNextMilestone(productUserId: string)
export async function validateProgramStructure(programId: string)
export async function calculateProgramProgress(productUserId: string, programId: string)
```

**Server Action Error Handling Pattern:**
[Source: Story 2.3 Dev Notes]
```typescript
export async function serverActionName(data: ActionData) {
  try {
    // Authentication check using getCurrentProductUser()
    // Validation using Zod schemas
    // Business logic with PayloadCMS Local API getPayload()
    // Revalidate relevant paths with revalidatePath()
    return { success: true, data: result, errorType: null }
  } catch (error) {
    console.error('Server Action Error:', error)
    return { 
      success: false, 
      error: error.message,
      errorType: 'validation' | 'authentication' | 'not_found' | 'system_error'
    }
  }
}
```

### Component Specifications
[Source: architecture/frontend-architecture.md#zustand-store-structure]

**Program Store Extensions Required:**
```typescript
// src/stores/program-store.ts (extend existing)
interface ProgramState {
  selectedProgram: Program | null
  currentProgress: {
    currentMilestone: number
    currentDay: number
    totalDays: number
    totalMilestones: number
    completionPercentage: number
  } | null
  setSelectedProgram: (program: Program | null) => void
  updateProgress: (milestone: number, day: number) => void
  calculateProgress: (program: Program, milestone: number, day: number) => ProgressData
}
```

### File Locations
[Source: architecture/unified-project-structure.md]

**Server Actions:**
- Extend existing: `src/actions/programs.ts` (add new progress tracking functions)

**Utilities:**
- Create new: `src/utils/progress.ts` (progress calculation utilities)
- Create new: `src/utils/validation.ts` (progress validation functions)

**Types:**
- Extend existing: `src/types/program.ts` (add progress interfaces)
- Extend existing: `src/types/auth.ts` (add progress tracking types)

**State Management:**
- Extend existing: `src/stores/program-store.ts` (add progress tracking state)

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Server action tests: `tests/actions/programs.test.ts` (extend existing)
- Utility tests: `tests/utils/progress.test.ts` (create new)
- Utility tests: `tests/utils/validation.test.ts` (create new)

**Testing Framework and Patterns:**
- Backend: Vitest for server action and utility testing
- Focus on custom progress tracking logic, not PayloadCMS framework functionality
- Mock PayloadCMS Local API for isolated business logic testing

**Story-Specific Test Cases:**
- Test progress initialization with various program structures and edge cases
- Test milestone and day advancement with boundary conditions and validation
- Test progress calculation utilities with different program configurations
- Test error handling for invalid program structures and progress conflicts
- Test data integrity validation and rollback mechanisms
- Test state management persistence and rehydration across sessions

### Technical Constraints
[Source: architecture/tech-stack.md, architecture/coding-standards.md]

**Technology Stack:**
- TypeScript 5.3+, Next.js 15.5+, React 19+
- Zustand for state management with persistence
- PayloadCMS 3.53+ Local API for data operations
- Zod 4.1+ for schema validation

**Coding Standards:**
- File names: kebab-case (progress.ts, validation.ts)
- Server actions: camelCase (advanceToNextDay, validateProgramStructure)
- Type definitions: PascalCase in src/types/
- All progress operations must maintain data integrity

**Data Integrity Requirements:**
- All progress updates must be atomic operations
- Progress validation before every state change
- Rollback mechanisms for failed progress updates
- Consistency checks between user progress and program structure

### Testing
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Server action tests: `tests/actions/programs.test.ts` (extend existing file)
- Utility tests: `tests/utils/progress.test.ts` (create new file)
- Validation tests: `tests/utils/validation.test.ts` (create new file)

**Test Standards:**
- Use Vitest for all backend testing
- Mock PayloadCMS Local API for isolated unit testing
- Focus on testing custom business logic for progress tracking
- Test error conditions and edge cases thoroughly
- Validate data integrity and consistency in all scenarios

**Testing Requirements:**
- Test progress initialization with various program configurations
- Test boundary conditions for milestone and day advancement
- Test progress calculation accuracy with different program structures
- Test error handling and rollback mechanisms
- Test state persistence and rehydration functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-11 | 1.0 | Initial story creation for user progress initialization with comprehensive architecture context and progress tracking requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
N/A - Task 1 completed without debugging issues

### Completion Notes List
- **Task 1 Complete**: Enhanced `assignProgramToUser` server action with comprehensive program structure validation
- Added `validateProgramStructure` helper function that validates:
  - Program has milestones array
  - At least one milestone exists
  - Each milestone has days array with at least one day
  - Each day has valid dayType ('workout' or 'rest')
  - Workout days have exercises (unless AMRAP)
- Updated program fetching to use depth: 2 for full structure validation
- Enhanced publishedStatus validation with clearer error messages
- Maintained proper 0-based indexing for milestone and day initialization
- Added comprehensive test coverage for all validation scenarios

- **Task 2 Complete**: Implemented milestone and day progression server actions
- Created `advanceToNextDay` server action with comprehensive validation:
  - Validates user authentication and active program
  - Checks program availability and publication status
  - Handles day advancement within milestone
  - Automatically advances to next milestone when reaching end of milestone days
  - Detects program completion when finishing last day of last milestone
  - Includes proper boundary checks and error handling
- Created `advanceToNextMilestone` server action with validation:
  - Validates user authentication and active program status
  - Checks program availability and structure
  - Prevents advancement beyond final milestone
  - Resets to first day of new milestone
  - Comprehensive error handling for edge cases
- Enhanced `UpdateProgressResult` type to include 'not_found' error type
- Added null-safety for user progress fields with proper defaults
- Comprehensive test coverage for all progression scenarios and edge cases

- **Task 3 Complete**: Created comprehensive progress tracking utilities
- Created `src/utils/progress.ts` with extensive progress calculation functions:
  - `calculateProgramProgress`: Comprehensive program progress with completion percentage
  - `calculateMilestoneProgress`: Detailed milestone-specific progress tracking
  - `calculateProgramAnalytics`: Workout/rest day breakdown and completion estimates
  - `validateProgressConsistency`: Data integrity validation with error/warning detection
- Implemented helper functions for program structure analysis:
  - Total program days, workout days, and rest days calculation
  - Absolute day position tracking within programs
  - Completed days by type (workout/rest) calculation
  - Milestone day breakdown analysis
- Added TypeScript interfaces for strongly-typed progress data
- Enhanced vitest configuration to include utility tests in test suite
- Created comprehensive test coverage with 39 test cases covering all functions and edge cases
- All tests passing with proper TypeScript type safety

- **Task 4 Complete**: Implemented progress persistence and state management
- Enhanced program store (`src/stores/program-store.ts`) with comprehensive progress tracking:
  - Added calculated progress data state (ProgramProgress, ProgramAnalytics)
  - Implemented optimistic update mechanism with pending updates tracking
  - Added sync status tracking (isSyncing, lastSyncTimestamp)
  - Created automatic progress recalculation on program/progress changes
  - Implemented state persistence with selective data partitioning
  - Added rehydration logic with automatic progress recalculation on app startup
- Created progress synchronization service (`src/lib/progress-sync.ts`):
  - Implemented optimistic updates with rollback capability for day/milestone advancement
  - Added queue-based sync operation management to prevent race conditions
  - Created singleton service pattern for global progress sync coordination
  - Implemented automatic sync on app visibility changes and startup
  - Added comprehensive error handling with progress state restoration
- Created progress initialization hook (`src/hooks/use-progress-initialization.ts`):
  - Built initialization state management with error tracking
  - Implemented progress data validation before initialization
  - Added automatic rehydration for stored progress data
  - Created progress initialization guard for component readiness
  - Integrated app visibility handling for background sync
- All code passes TypeScript type checking and ESLint validation

- **Task 5 Complete**: Implemented comprehensive error handling and validation with rollback mechanisms
- Added extensive progress validation utilities (`src/utils/validation.ts`):
  - `validateUserProgress`: Comprehensive validation with detailed error categorization
  - `ProgressValidationError` interface with user-friendly messages and repair suggestions
  - `repairProgressWithRollback`: Automatic progress repair with rollback capability
  - Support for 9 different error types (corrupted_progress, program_structure_changed, etc.)
- Enhanced all progress server actions with comprehensive validation:
  - `advanceToNextDay`: Added validation, error handling, and rollback mechanisms
  - `advanceToNextMilestone`: Added validation, error handling, and rollback mechanisms  
  - `updateUserProgress`: Added validation, error handling, and rollback mechanisms
- Implemented intelligent progress repair mechanisms:
  - Automatic detection of corrupted progress positions
  - Smart position adjustment to nearest valid location
  - Fallback to program beginning when repair impossible
  - Comprehensive rollback on operation failures
- Added detailed user-friendly error messages for all progress conflict scenarios
- Enhanced `UpdateProgressResult` type with repair action information for client-side handling
- All edge cases handled: corrupted progress, program structure changes, invalid positions
- Data integrity maintained through atomic operations and rollback mechanisms
- Comprehensive TypeScript type safety throughout implementation

### File List
- **Modified**: `src/actions/programs.ts` - Enhanced with comprehensive error handling, validation, and rollback mechanisms for all progress functions
- **Modified**: `src/types/program.ts` - Enhanced UpdateProgressResult with new error types and repair action information
- **Enhanced**: `src/utils/validation.ts` - Added extensive progress validation utilities and error handling functions
- **Modified**: `tests/api/programs.test.ts` - Added comprehensive validation and progression test cases
- **Created**: `src/utils/progress.ts` - Comprehensive progress tracking utilities with calculation and validation functions
- **Created**: `tests/utils/progress.test.ts` - Complete test suite for progress utilities with 39 test cases
- **Modified**: `vitest.config.mts` - Added tests/utils/** pattern to include utility tests in test suite
- **Modified**: `src/stores/program-store.ts` - Enhanced with progress tracking state, optimistic updates, and synchronization features
- **Created**: `src/lib/progress-sync.ts` - Progress synchronization service with optimistic updates and error handling
- **Created**: `src/hooks/use-progress-initialization.ts` - React hooks for progress initialization and rehydration management

## QA Results

*Results from QA Agent review will be populated here*