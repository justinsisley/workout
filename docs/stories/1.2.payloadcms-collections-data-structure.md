# Story 1.2: PayloadCMS Collections and Embedded Data Structure

## Status

Ready for Development

## Story

**As a** developer,
**I want** all PayloadCMS collections defined with embedded program structure,
**so that** the data structure supports efficient admin workflows and eliminates context switching between collections.

## Acceptance Criteria

1. **Exercises collection** includes title, description, video URL, and alternatives (unchanged)
2. **Programs collection** includes embedded milestones, days, and exercise references in single document
3. **Milestones are embedded in programs** with name, theme, objective, and embedded days array
4. **Days are embedded in milestones** with dayType ('workout'|'rest') and embedded exercises array for workout days
5. **Exercises are referenced by ID** within embedded day structures with complete workout details (sets, reps, rest periods, weight, notes)
6. **Product users collection** includes username, current program, milestone, and day tracking
7. **Exercise completions collection** includes user, exercise, program, milestone index, and day index
8. **All relationships are properly configured** between collections
9. **Collection validation rules** ensure data integrity with progressive validation
10. **Admin interface supports single-page editing** of complete program structure

## Tasks / Subtasks

### Phase 1: Remove Old Collections (AC: 2, 3, 4)

- [ ] **Remove Milestones Collection**
  - [ ] Delete `src/payload/collections/milestones.ts`
  - [ ] Remove from `src/payload/payload.config.ts`
  - [ ] Update TypeScript types

- [ ] **Remove Sessions Collection**
  - [ ] Delete `src/payload/collections/sessions.ts`
  - [ ] Remove from `src/payload/payload.config.ts`
  - [ ] Update TypeScript types

### Phase 2: Rewrite Programs Collection (AC: 2, 3, 4, 5)

- [ ] **Implement Embedded Schema**
  - [ ] Create new Programs collection with embedded milestones array
  - [ ] Implement embedded days array within milestones
  - [ ] Implement embedded exercises array within workout days only
  - [ ] Configure exercise references with complete workout details (sets, reps, rest periods, weight, notes)
  - [ ] Add progressive validation hooks

- [ ] **Configure Admin Interface**
  - [ ] Set up collapsible sections for milestones, days, exercises
  - [ ] Configure conditional field visibility (workout vs rest days)
  - [ ] Show exercises array only for workout days
  - [ ] Show rest notes only for rest days
  - [ ] Implement drag-and-drop ordering for arrays
  - [ ] Add proper field descriptions and validation

### Phase 3: Update Related Collections (AC: 6, 7)

- [ ] **Update ProductUsers Collection**
  - [ ] Update currentMilestone to use milestone index instead of relationship
  - [ ] Update currentDay to use day index
  - [ ] Maintain currentProgram relationship

- [ ] **Update ExerciseCompletions Collection**
  - [ ] Add milestoneIndex field (number)
  - [ ] Add dayIndex field (number)
  - [ ] Remove session relationship
  - [ ] Update program relationship

### Phase 4: Update Configuration and Types (AC: 8, 9)

- [ ] **Update PayloadCMS Configuration**
  - [ ] Remove milestone and session collections from payload.config.ts
  - [ ] Update collection imports
  - [ ] Regenerate TypeScript types

- [ ] **Update TypeScript Interfaces**
  - [ ] Update payload-types.ts
  - [ ] Update custom type definitions
  - [ ] Ensure type safety across all collections

### Phase 5: Testing and Validation (AC: 10)

- [ ] **Update Unit Tests**
  - [ ] Rewrite collection tests for embedded schema
  - [ ] Test embedded array functionality
  - [ ] Test exercise reference relationships
  - [ ] Validate progressive validation

- [ ] **Integration Testing**
  - [ ] Test complete program creation workflow
  - [ ] Test admin interface functionality
  - [ ] Validate data integrity
  - [ ] Test TypeScript compilation

## Dev Notes

### Embedded Schema Architecture

**Programs Collection Structure:**

```typescript
interface Program {
  id: string
  name?: string
  description?: string
  objective?: string
  milestones: {
    name?: string
    theme?: string
    objective?: string
    days: {
      dayType: 'workout' | 'rest'
      // For workout days: exercises array with complete workout details
      exercises?: {
        exercise: string // Reference to Exercise ID
        sets: number
        reps: number
        restPeriod?: number // Rest time between sets (seconds)
        weight?: number // Weight to use (lbs)
        notes?: string // Additional instructions
      }[]
      // For rest days: optional rest day notes
      restNotes?: string
    }[]
  }[]
  isPublished: boolean
  createdAt: Date
  updatedAt: Date
}
```

**Key Benefits:**

- Single-page editing of complete program structure
- No context switching between collections
- Atomic updates of entire program
- Better data locality and performance
- Simplified admin workflow

**Conditional Logic:**

- **Workout Days:** Show exercises array with sets, reps, rest periods, weight, and notes
- **Rest Days:** Show rest notes field, hide exercises array
- **Exercise References:** Reference Exercise collection by ID, not embedded exercise data
- **Complete Workout Details:** All session-level data (sets, reps, etc.) embedded within day structure

### Implementation Strategy

**Clean Implementation Approach:**

1. Delete existing normalized collections and data
2. Implement new embedded schema collections
3. Test admin interface functionality
4. Validate complete program creation workflow

**Rollback Plan:**

- Revert code changes if needed
- No data migration complexity since starting fresh

### Testing Requirements

**Collection Testing:**

- Test embedded array functionality
- Test exercise reference relationships
- Test progressive validation
- Test admin interface generation

**Integration Testing:**

- Test complete program creation workflow
- Validate admin interface functionality
- Test TypeScript type safety

## Change Log

| Date       | Version | Description                                       | Author   |
| ---------- | ------- | ------------------------------------------------- | -------- |
| 2024-12-19 | 2.0     | Complete rewrite for embedded schema architecture | Bob (SM) |

## Dev Agent Record

To be populated by development agent

## QA Results

To be populated by QA agent
