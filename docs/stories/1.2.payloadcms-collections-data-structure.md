# Story 1.2: PayloadCMS Collections and Data Structure

## Status

Ready for Development

## Story

**As a** developer,
**I want** all PayloadCMS collections defined with proper relationships,
**so that** the data structure supports the complete program hierarchy and user management.

## Acceptance Criteria

1. **Exercises collection** includes title, description, video URL, and alternatives
2. **Programs collection** includes name, description, objective, culminating event, and milestone relationships
3. **Milestones collection** includes name, theme, objective, culminating event, and days array with relationship-based ordering
4. **Days are embedded in milestones** with dayType ('workout'|'rest'), sessions array, and relationship-based ordering (day number derived from array position)
5. **Sessions collection** includes exercises with sets, reps, and rest periods
6. **Product users collection** includes phone number, current program, milestone, and day tracking
7. **Exercise completions collection** includes user, exercise, reps, sets, weight, time, and date
8. **All relationships are properly configured** between collections
9. **Collection validation rules** ensure data integrity and required fields

## Tasks / Subtasks

- [x] **Create Exercises Collection** (AC: 1)
  - [x] Define Exercises collection with title, description, and video URL fields
  - [x] Implement alternatives relationship for exercise substitutions
  - [x] Configure progressive validation for draft content creation
  - [x] Add proper field validation and descriptions
  - [x] Test exercise creation with alternative relationships

- [ ] **Create Sessions Collection** (AC: 5)
  - [ ] Define Sessions collection with name and exercises array
  - [ ] Implement exercise relationships with sets, reps, rest periods, weight, and notes
  - [ ] Configure drag-and-drop ordering for exercises within sessions
  - [ ] Add proper field validation for numeric values
  - [ ] Test session creation with exercise relationships

- [ ] **Create Milestones Collection** (AC: 3)
  - [ ] Define Milestones collection with name, theme, objective, and culminating event fields
  - [ ] Implement days array with dayType ('workout'|'rest') and sessions array
  - [ ] Configure conditional field display for workout vs rest days
  - [ ] Add progressive validation for draft content creation
  - [ ] Test milestone creation with embedded days and session relationships

- [ ] **Create Programs Collection** (AC: 2)
  - [ ] Define Programs collection with name, description, objective, and culminating event fields
  - [ ] Implement milestone relationship array with drag-and-drop ordering
  - [ ] Add isPublished checkbox for content visibility control
  - [ ] Configure progressive validation allowing draft content creation
  - [ ] Test program creation with milestone relationships

- [ ] **Create ProductUsers Collection** (AC: 6)
  - [ ] Define ProductUsers collection with phone number, display name, and program tracking fields
  - [ ] Configure custom access controls for admin-only management
  - [ ] Set up proper field validation and indexing for phone numbers
  - [ ] Test collection creation and basic CRUD operations

- [ ] **Create ExerciseCompletions Collection** (AC: 7)
  - [ ] Define ExerciseCompletions collection with user, exercise, and session relationships
  - [ ] Implement performance tracking fields (sets, reps, weight, time, notes)
  - [ ] Configure proper access controls and validation
  - [ ] Add completedAt timestamp and optional fields
  - [ ] Test completion tracking with all relationship fields

- [ ] **Configure Collection Relationships** (AC: 8)
  - [ ] Verify all relationship fields are properly configured between collections
  - [ ] Test relationship queries and data integrity
  - [ ] Ensure proper foreign key constraints and validation
  - [ ] Validate drag-and-drop ordering functionality for arrays
  - [ ] Test relationship deletion and cascade behavior

- [ ] **Implement Collection Validation Rules** (AC: 9)
  - [ ] Configure progressive validation strategy allowing draft content creation
  - [ ] Set up proper field validation for required vs optional fields
  - [ ] Implement publishing controls with isPublished checkboxes
  - [ ] Add admin interface descriptions and warnings for incomplete content
  - [ ] Test validation rules and error handling

- [ ] **Generate TypeScript Types** (AC: 8, 9)
  - [ ] Run PayloadCMS type generation to create updated payload-types.ts
  - [ ] Verify all collection types are properly generated
  - [ ] Update existing type definitions to match new collections
  - [ ] Test TypeScript compilation with new types
  - [ ] Validate type safety in server actions and components

- [ ] **Create Unit Tests for Collections** (AC: 8, 9)
  - [ ] Write unit tests for each collection definition
  - [ ] Test collection creation, validation, and relationship functionality
  - [ ] Verify access controls and permission systems
  - [ ] Test progressive validation and publishing controls
  - [ ] Ensure all tests pass and provide good coverage

## Dev Notes

### Previous Story Insights

From Story 1.1 completion:

- PayloadCMS 3.54.0 is successfully integrated with TypeScript support
- MongoDB connection is configured and working via DATABASE_URI environment variable
- PayloadCMS admin interface is accessible at `/admin` route
- Basic collections (users.ts, media.ts) exist and follow kebab-case naming convention
- TypeScript types are generated successfully via payload-types.ts
- Project structure follows PayloadCMS bootstrap conventions with collections in `src/payload/collections/`

### PayloadCMS Collection Architecture Requirements

[Source: architecture/payloadcms-collections.md#payloadcms-first-architecture]

**Key Principles:**

- **No Raw MongoDB:** All data structures defined using PayloadCMS field types
- **Field-Based Definition:** Database schema and admin interfaces automatically generated
- **Full Type Safety:** PayloadCMS Local API provides complete TypeScript type safety
- **Relationship Management:** Complex relationships handled through PayloadCMS relationship fields
- **Server-Side Operations:** All data operations use PayloadCMS Local API in server actions

### Progressive Validation Strategy

[Source: architecture/payloadcms-collections.md#progressive-validation-strategy]

**Critical Implementation Requirements:**

- **No Required Fields at Save Time:** All content can be saved in draft state without required fields
- **Publishing Controls:** `isPublished` checkbox controls product user visibility
- **Admin Interface Enhancements:** Field descriptions indicate publishing requirements
- **Save Early, Save Often:** Allow saving content at any stage of completion

### Admin User vs Product User Separation

[Source: architecture/payloadcms-collections.md#admin-user-vs-product-user-separation-strategy]

**Critical Separation Requirements:**

- **PayloadCMS Admin Users (`users` collection):** Standard PayloadCMS authentication (email/password)
- **Product Users (`productUsers` collection):** Custom SMS OTP authentication only, completely separate
- **Security Isolation:** Admin user access and product user access use different authentication systems
- **Data Integrity:** Product user data is isolated from admin user system data

### Collection Definitions and Relationships

[Source: architecture/payloadcms-collections.md#collection-definitions]

**Required Collections:**

1. **ProductUsers Collection:**
   - `phoneNumber` (text, required, unique, indexed)
   - `displayName` (text, optional)
   - `currentProgram` (relationship to programs)
   - `currentMilestone` (relationship to milestones)
   - `currentDay` (number, default 1)
   - `lastWorkoutDate` (date, optional)
   - `totalWorkoutsCompleted` (number, default 0)
   - Access controls: Only authenticated admin users can manage

2. **Programs Collection:**
   - `name` (text, optional for drafts)
   - `description` (textarea, optional for drafts)
   - `objective` (text, optional for drafts)
   - `culminatingEvent` (relationship to sessions, optional for drafts)
   - `milestones` (array with milestone relationships, drag-and-drop ordering)
   - `isPublished` (checkbox, default false)

3. **Milestones Collection:**
   - `name` (text, optional for drafts)
   - `theme` (text, optional for drafts)
   - `objective` (text, optional for drafts)
   - `culminatingEvent` (relationship to sessions, optional for drafts)
   - `days` (array with dayType: 'workout'|'rest' and session relationships)

4. **Sessions Collection:**
   - `name` (text, optional, admin organization only)
   - `exercises` (array with exercise relationships, sets, reps, restPeriod, weight, notes)
   - Drag-and-drop ordering for exercises within sessions

5. **Exercises Collection:**
   - `title` (text, optional for drafts)
   - `description` (textarea, optional for drafts)
   - `videoUrl` (text, optional for drafts, YouTube URLs)
   - `alternatives` (relationship to exercises, hasMany: true)

6. **ExerciseCompletions Collection:**
   - `productUser` (relationship to productUsers, required)
   - `exercise` (relationship to exercises, required)
   - `session` (relationship to sessions, required)
   - `sets` (number, required)
   - `reps` (number, required)
   - `weight` (number, optional)
   - `time` (number, optional)
   - `completedAt` (date, required)
   - `notes` (textarea, optional)

### File Locations and Naming Conventions

[Source: architecture/unified-project-structure.md#payloadcms-collections]

**Collection File Locations:**

- All collection files in `src/payload/collections/`
- File naming: kebab-case (e.g., `product-users.ts`, `exercise-completions.ts`)
- Collection slugs: kebab-case (e.g., `productUsers`, `exerciseCompletions`)

**TypeScript Type Generation:**

- Types automatically generated in `src/payload/payload-types.ts`
- Run `npm run generate:types` to regenerate after collection changes
- All server actions and components import types from this file

### Testing Requirements

[Source: architecture/testing-strategy.md#backend-tests]

**Collection Testing Standards:**

- **Test File Location:** `tests/payload/collections.test.ts`
- **Testing Framework:** Vitest for unit and integration tests
- **Test Standards:** All collections must have unit tests for creation, validation, and relationships
- **Testing Patterns:** Use proper mocking for PayloadCMS operations, test both success and error scenarios

**Required Test Coverage:**

- Collection creation and field validation
- Relationship functionality and data integrity
- Access controls and permission systems
- Progressive validation and publishing controls
- TypeScript type generation and compilation

### Technical Constraints

[Source: architecture/tech-stack.md#technology-stack-table]

**PayloadCMS Version:** 3.53+ (currently 3.54.0 installed)
**Database:** MongoDB 7.0+ with Docker Compose for local development
**TypeScript:** 5.3+ with strict type checking enabled
**Validation:** Zod 4.1+ for runtime type validation (already installed)

### Critical Implementation Notes

1. **Progressive Validation:** All collections must allow saving without required fields initially
2. **Relationship Integrity:** All relationship fields must be properly configured with correct relationTo values
3. **Admin Interface:** Field descriptions must indicate publishing requirements and provide clear guidance
4. **Type Safety:** All collections must generate proper TypeScript types
5. **Access Controls:** ProductUsers collection must have admin-only access controls
6. **File Naming:** All collection files must use kebab-case naming convention
7. **Array Ordering:** Milestone and exercise arrays must support drag-and-drop reordering
8. **Conditional Fields:** Milestone days must show/hide session fields based on dayType

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md#backend-tests]

**Test File Location:** All collection tests in `tests/payload/collections.test.ts`
**Testing Frameworks:** Vitest for unit and integration tests
**Test Standards:**

- All collections must have unit tests for creation, validation, and relationships
- Test both success and error scenarios
- Include integration tests for PayloadCMS operations
- Verify access controls and permission systems

**Testing Patterns:**

- Use proper mocking for PayloadCMS operations
- Test relationship queries and data integrity
- Validate progressive validation and publishing controls
- Ensure TypeScript type generation works correctly

**Required Test Coverage:**

- Collection creation and field validation
- Relationship functionality and data integrity
- Access controls and permission systems
- Progressive validation and publishing controls
- TypeScript type generation and compilation

## Change Log

| Date       | Version | Description                                                                                                 | Author     |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------- | ---------- |
| 2025-01-27 | 1.0     | Initial story creation with PayloadCMS collections and progressive validation strategy                      | Bob (SM)   |
| 2025-01-27 | 1.1     | Fixed task ordering to follow dependency chain: Exercises → Sessions → Milestones → Programs → ProductUsers | Bob (SM)   |
| 2025-01-27 | 1.2     | Validated story draft and resolved architectural discrepancy with Epic 1.2 - marked ready for development   | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Full Stack Developer Agent)

### Debug Log References

- TypeScript compilation errors resolved for field descriptions and validation function types
- PayloadCMS collection configuration validated and tested

### Completion Notes List

- ✅ **Exercises Collection Created**: Successfully implemented with all required fields (title, description, videoUrl, alternatives, isPublished)
- ✅ **Progressive Validation**: Configured to allow draft content creation without required fields
- ✅ **YouTube URL Validation**: Custom validation function for video URLs with proper error handling
- ✅ **Self-Referencing Relationship**: Alternatives field properly configured for exercise substitutions
- ✅ **Access Controls**: Admin-only access controls implemented for CRUD operations
- ✅ **TypeScript Types**: Generated successfully via `npm run generate:types`
- ✅ **Unit Tests**: Comprehensive test suite created and passing (5/5 tests)
- ✅ **Build Validation**: Next.js build successful with no TypeScript errors

### File List

**Created Files:**

- `src/payload/collections/exercises.ts` - Exercises collection definition
- `tests/payload/collections.test.ts` - Unit tests for collections

**Modified Files:**

- `src/payload/payload.config.ts` - Added Exercises collection import and registration
- `vitest.config.mts` - Updated to include payload tests directory
- `src/payload/payload-types.ts` - Auto-generated TypeScript types (via npm run generate:types)

## QA Results

_This section will be populated by the QA agent after implementation review_
