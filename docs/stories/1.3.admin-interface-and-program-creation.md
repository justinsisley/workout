# Story 1.3: Admin Interface and Program Creation

## Status

Ready for Enhancement (Course Correction Required)

## Story

**As an** admin user,
**I want** a functional PayloadCMS admin interface with embedded program editing,
**so that** I can create and manage complete workout programs from a single interface without context switching.

## Acceptance Criteria

1. **Admin authentication** works with PayloadCMS built-in user system
2. **Single-page program creation** allows creating complete programs with embedded milestones, days, and exercises
3. **Exercise library management** enables adding, editing, and organizing exercises
4. **Embedded milestone editing** allows defining themes, objectives within the program interface
5. **Embedded day management** enables creating workout and rest days with exercises directly in the program
6. **Embedded exercise configuration** allows adding exercises with sets, reps, rest periods, weight, and notes within days
7. **Conditional field visibility** shows exercises array only for workout days and rest notes only for rest days
8. **Progressive validation** allows saving incomplete programs as drafts while preventing publishing incomplete content
9. **Drag-and-drop ordering** enables reordering milestones, days, and exercises within the program interface
10. **Collapsible sections** manage complexity with expandable/collapsible milestone and day sections
11. **Admin interface is responsive** and works on desktop for program creation
12. **All CRUD operations** work correctly for all collection types

## Tasks / Subtasks

- [x] **Time duration input with unit selector** (AC: 6) [ENHANCED from course correction]
  - [x] ~~Add duration field to exercise configuration within embedded days~~ (COMPLETED - needs enhancement)
  - [x] **ENHANCE**: Replace single duration field with durationValue + durationUnit fields
  - [x] **ENHANCE**: Add durationValue number field (0-999 range)
  - [x] **ENHANCE**: Add durationUnit selector (seconds/minutes/hours options)
  - [x] **ENHANCE**: Implement conditional field logic (unit required if value set, value required if unit set)
  - [x] **ENHANCE**: Update field layout to accommodate dual fields in exercise row with visual grouping
  - [x] **ENHANCE**: Add validation for reasonable duration ranges per unit type
  - [x] **ENHANCE**: Update field descriptions for intuitive usage guidance
  - [Source: course-corrections/time-duration-ux-enhancement.md]

- [x] **Distance input with unit selector** (AC: 6) [ENHANCEMENT - Course Correction Completed]
  - [x] Replace single distance field with distanceValue + distanceUnit fields
  - [x] Add distanceValue number field (0-999 range, 0.1 step for precision)
  - [x] Add distanceUnit selector (meters/miles options)
  - [x] Implement conditional field logic (unit required if value set, value required if unit set)
  - [x] Update field layout to accommodate dual fields in exercise row with visual grouping
  - [x] Add validation for reasonable distance ranges per unit type
  - [x] Update field descriptions for intuitive usage guidance
  - [Source: course-corrections/distance-ux-enhancement.md]

- [ ] **Enable/verify admin authentication (Payload default users)** (AC: 1)
  - [ ] Confirm `users` collection uses Payload auth and admin UI is accessible
  - [ ] Verify access control on admin-only collections
  - [ ] Smoke test login/logout
  - [Source: architecture/payloadcms-collections.md#users-collection-payloadcms-admin-users]

- [ ] **Programs collection embedded editing UX** (AC: 2, 4, 5, 6, 7, 9, 10)
  - [ ] Ensure `programs` has embedded `milestones -> days -> exercises` arrays
  - [ ] Verify conditional display for workout vs rest day fields
  - [ ] Verify drag-and-drop ordering on arrays and collapsed sections
  - [ ] Ensure admin descriptions/labels guide editors
  - [Source: architecture/payloadcms-collections.md#programs-collection-embedded-architecture]

- [ ] **Exercise library management** (AC: 3)
  - [ ] Confirm CRUD operations for `exercises` with title, description, video URL, alternatives
  - [ ] Ensure alternatives relationship is functional
  - [Source: architecture/payloadcms-collections.md#exercises-collection]

- [ ] **Progressive validation + publishing controls** (AC: 8)
  - [ ] Verify draft saves without required fields
  - [ ] Validate publishing is blocked until required fields present; error messaging clear
  - [Source: architecture/payloadcms-collections.md#progressive-validation-strategy]

- [ ] **Access control checks** (AC: 12)
  - [ ] Confirm admin-only access to collections via Payload access config
  - [ ] Verify CRUD works for `programs`, `exercises`, `productUsers`, `exerciseCompletions`
  - [Source: architecture/payloadcms-collections.md#payloadcms-first-architecture]

- [ ] **Admin interface responsiveness** (AC: 11)
  - [ ] Manual check of Payload admin on desktop sizes
  - [ ] Verify embedded UI remains usable as arrays grow
  - [Source: architecture/frontend-architecture.md#component-architecture]

- [ ] **Testing**
  - [ ] Update/extend integration tests for embedded admin configuration (arrays, conditional fields)
  - [ ] Verify Payload type generation and TS compilation
  - [ ] Ensure E2E admin smoke path (optional manual) is documented
  - [Source: architecture/testing-strategy.md#testing-pyramid]

## Dev Notes

### Previous Story Insights

- Story 1.2 implemented embedded structure with comprehensive progressive validation hooks that allow draft saves without required fields while blocking publish until complete. The validation includes embedded array validation, exercise reference validation, and conditional field requirements based on dayType. Reuse these specific validation patterns and admin UI configurations for seamless program creation workflow in this story.
- Story 1.2 added collapsible sections, drag-and-drop ordering, and conditional field visibility (exercises array only for workout days) in the admin interface - extend these patterns for the complete program creation experience.

### Architecture References (implementation guidance)

- Admin users vs product users separation; use Payload default auth for admins only
  - [Source: architecture/payloadcms-collections.md#admin-user-vs-product-user-separation-strategy]
  - [Source: architecture/payloadcms-collections.md#users-collection-payloadcms-admin-users]

- Programs embedded schema fields, conditional visibility, drag-and-drop, collapsible sections, and publishing control
  - [Source: architecture/payloadcms-collections.md#programs-collection-embedded-architecture]

- Exercise library fields and relationships
  - [Source: architecture/payloadcms-collections.md#exercises-collection]

- Progressive validation strategy for drafts vs publish
  - [Source: architecture/payloadcms-collections.md#progressive-validation-strategy]

- Project structure location for Payload collections and admin routes
  - `src/payload/collections/*.ts`, `src/app/(payload)/admin/`
  - [Source: architecture/unified-project-structure.md]
  - [Source: architecture/frontend-architecture.md#route-organization]

- Testing scope and organization
  - [Source: architecture/testing-strategy.md#testing-pyramid]

### Time Duration Dual-Field Implementation [ENHANCED]

**Course Correction Enhancement (September 9, 2025):**

Based on comprehensive analysis with Architecture and UX expert review, the single duration field approach has been enhanced to use dual-field semantic storage for improved UX.

**Current vs. Proposed Implementation:**

```typescript
// BEFORE (Single Field - Completed but needs enhancement)
{
  duration?: number // Raw seconds only (e.g., 3600) - UNINTUITIVE for users
}

// AFTER (Dual Field - Course Correction Enhancement)
{
  durationValue?: number // The numeric value (e.g., 1)
  durationUnit?: 'seconds' | 'minutes' | 'hours' // The time unit
}
```

**Admin Interface Requirements:**

- **Dual-Field Layout:** Duration value and unit selector appear as paired fields with visual grouping
- **Visual Pairing:** Container with subtle background/border groups both fields as single logical unit
- **Conditional Validation:** Both fields required together (value requires unit, unit requires value)
- **Field Positioning:** Appears alongside existing sets, reps, weight, notes fields in exercise row
- **Unit Options:** Dropdown with Seconds, Minutes, Hours options
- **Value Range:** 0-999 with unit-contextual validation (e.g., max 99 hours)

**Enhanced Time-Based Exercise Support:**

- **Intuitive Input:** Admin enters "1 hour" instead of "3600 seconds" for ruck marches
- **Semantic Storage:** Database preserves original units for natural display
- **Natural Display:** End users see "1 hour" not "3600 seconds" across all interfaces
- **Use Cases:**
  - Plank: durationValue: 30, durationUnit: 'seconds' → displays "30 seconds"
  - Timed run: durationValue: 5, durationUnit: 'minutes' → displays "5 minutes"
  - Ruck march: durationValue: 1, durationUnit: 'hours' → displays "1 hour"

**Implementation Specifications:**

From Architecture Review - Production-ready PayloadCMS field configuration:

- Field validation with sibling dependency checking
- Visual field grouping with 50% width fields
- Unit-contextual range validation
- Comprehensive error messaging for incomplete specifications

From UX Review - Optimal user experience patterns:

- Progressive validation with clear error recovery
- Accessible markup with proper ARIA relationships
- Responsive design maintaining logical groupings
- Visual design system integration

### Testing

**Test File Locations:**

- Payload collections: `tests/payload/collections.test.ts`
- Admin interface integration: `tests/payload/admin-integration.test.ts`
- E2E admin workflows: `tests/e2e/admin-workflow.spec.ts`

**Testing Standards:**

- Use Vitest for unit/integration tests with PayloadCMS test environment
- Use Playwright for E2E testing of admin workflows
- Test embedded array functionality and conditional field visibility
- Validate progressive validation hooks prevent publishing incomplete programs
- Verify admin CRUD operations across all collections

**Specific Testing Requirements for this Story:**

- Test PayloadCMS admin authentication with default users collection
- Test single-page program creation with embedded milestones/days/exercises
- Test drag-and-drop reordering functionality
- Test collapsible sections behavior with large programs
- Validate conditional field visibility (exercises array for workout days only)
- Test progressive validation workflow (draft saves vs publish validation)
- [Source: architecture/testing-strategy.md#testing-pyramid]

## Change Log

| Date       | Version | Description                         | Author   |
| ---------- | ------- | ----------------------------------- | -------- |
| 2025-09-08 | 0.1     | Initial draft created from PRD/Arch | Bob (SM) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Completion Notes

- **Time duration input field** - Successfully implemented basic duration field in exercise configuration within embedded days array in `src/payload/collections/programs.ts`. Field accepts seconds (0-3600 max), positioned alongside existing exercise fields (sets, reps, weight), with clear description for time-based exercises. TypeScript compilation verified successful.

- **✅ COURSE CORRECTION COMPLETED (Sept 9, 2025)** - Enhanced single duration field to dual-field approach (durationValue + durationUnit) with intuitive UX. Implementation includes:
  - **Dual-field structure**: durationValue (number 0-999) + durationUnit (seconds/minutes/hours selector)
  - **Visual grouping**: 50% width fields appear side-by-side with proper field descriptions
  - **Progressive validation**: Both fields required together, enforced via beforeValidate hook with clear error messages
  - **Range validation**: Unit-contextual limits (99 hours max, 999 minutes max, 999 seconds max)
  - **Intuitive descriptions**: Clear examples (30 seconds for plank, 5 minutes for run, 1 hour for ruck march)
  - **TypeScript compatibility**: Full type safety verified with successful compilation

- **✅ DISTANCE INPUT ENHANCEMENT COMPLETED (Sept 9, 2025)** - Implemented dual-field distance input (distanceValue + distanceUnit) following same UX pattern as duration fields. Implementation includes:
  - **Dual-field structure**: distanceValue (number 0-999, 0.1 step precision) + distanceUnit (meters/miles selector)
  - **Visual grouping**: 50% width fields positioned side-by-side with comprehensive field descriptions
  - **Progressive validation**: Both fields required together, enforced via beforeValidate hook with detailed error messages
  - **Range validation**: Unit-contextual limits (100 miles max, 50,000 meters max) for reasonable exercise distances
  - **Intuitive descriptions**: Clear examples (1.5 miles for run, 500 meters for sprint, 3 miles for bike ride)
  - **TypeScript compatibility**: Full type safety verified with successful build compilation

### File List

- Modified: `src/payload/collections/programs.ts` - Enhanced duration field from single field to dual-field approach (durationValue + durationUnit) with full validation and intuitive UX
- Modified: `src/payload/collections/programs.ts` - Added distance input with dual-field approach (distanceValue + distanceUnit) with progressive validation and range checking

### Debug Log

No issues encountered during implementation.

### Change Log

| Date       | Change               | File                                  | Details                                                                                                                         |
| ---------- | -------------------- | ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| 2025-09-08 | Added duration field | `src/payload/collections/programs.ts` | Added optional duration field (seconds) to exercise configuration within embedded days, positioned after weight field           |
| 2025-09-09 | Enhanced duration UX | `src/payload/collections/programs.ts` | Replaced single duration field with durationValue + durationUnit dual-field approach with validation and intuitive descriptions |
| 2025-09-09 | Added distance input | `src/payload/collections/programs.ts` | Implemented distanceValue + distanceUnit dual-field approach with progressive validation and unit-specific range limits         |

## QA Results

_This section will be populated by the QA Agent during story validation and testing_
